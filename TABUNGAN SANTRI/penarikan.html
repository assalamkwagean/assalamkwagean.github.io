<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
            yellow: { 600: '#ca8a04', 500: '#eab308' }
          }
        }
      }
    }
  </script>
  <style>
    body {
      -webkit-text-size-adjust: 100%;
      /* GAS iframe compatibility */
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    html {
      height: 100%;
      overflow: auto;
    }

    /* GAS iframe specific fixes */
    .gas-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
      box-sizing: border-box;
    }

    input, textarea, select:not(.select2) {
      font-size: 16px !important;
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
      /* Prevent zoom on iOS */
      -webkit-appearance: none;
      appearance: none;
    }

    .select2-container--default .select2-selection--single {
      font-size: 16px !important;
      min-height: 44px !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
      height: 44px !important;
      display: flex !important;
      align-items: center !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 44px !important;
      color: #f1f5f9 !important;
    }

    .select2-dropdown {
      background-color: #334155 !important;
      border-color: #475569 !important;
    }

    .select2-container--default .select2-results__option {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #ca8a04 !important;
    }

    /* GAS header compensation */
    .gas-header-compensation {
      padding-top: 1rem;
    }

    /* Mobile-first responsive adjustments */
    @media (max-width: 640px) {
      .gas-container {
        padding: 0.5rem;
      }

      .text-2xl {
        font-size: 1.25rem;
      }

      .p-6 {
        padding: 1rem;
      }
    }

    /* GAS iframe specific media queries */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      h1 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.25rem;
      }

      .grid.grid-cols-1.md\\:grid-cols-2 {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }
  </style>
</head>
<body class="bg-slate-900 min-h-screen text-gray-100 gas-header-compensation">
   <div class="gas-container">
     <div class="container mx-auto px-2 md:px-4 py-4 md:py-8 max-w-4xl">
    <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-2xl font-bold text-yellow-400">Form Penarikan Saldo</h1>
          <p class="text-gray-400 text-sm mt-1"><?= CONFIG.PONDOK_NAME ?> <?= CONFIG.PESANTREN_NAME ?></p>
        </div>
        <button onclick="goBack()" class="px-4 py-2 bg-slate-700 text-gray-100 rounded-md hover:bg-slate-600 transition">
          <i class="fas fa-arrow-left mr-2"></i> Kembali
        </button>
      </div>

      <!-- Form -->
      <form id="penarikanForm" class="space-y-6">
        <!-- Santri Selection -->
        <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
          <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
            <i class="fas fa-user-graduate text-yellow-400 mr-2"></i>
            Data Santri
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="nis" class="block text-sm font-medium text-gray-300 mb-1">NIS/Nama Santri</label>
              <select id="nis" name="nis" class="select2 w-full" required>
                <option value="">Pilih Santri</option>
              </select>
            </div>
            <div>
              <label for="nama" class="block text-sm font-medium text-gray-300 mb-1">Nama Santri</label>
              <input type="text" id="nama" name="nama" class="w-full rounded-md p-2" readonly>
            </div>
          </div>
          
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-3 bg-slate-800 rounded border border-slate-600">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Saldo Saat Ini:</span>
                <span id="saldoSekarang" class="text-lg font-bold text-emerald-400">Rp 0</span>
              </div>
            </div>
            <div class="p-3 bg-slate-800 rounded border border-slate-600">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Limit Harian:</span>
                <span id="limitHarian" class="text-lg font-bold text-blue-400">Rp 0</span>
              </div>
            </div>
          </div>
          
          <div class="mt-3 p-3 bg-yellow-900 bg-opacity-30 rounded border border-yellow-700">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-300">Sudah Ditarik Hari Ini:</span>
              <span id="totalPenarikanHariIni" class="text-lg font-bold text-yellow-400">Rp 0</span>
            </div>
            <div class="flex justify-between items-center mt-2">
              <span class="text-sm font-medium text-gray-200">Sisa Limit Hari Ini:</span>
              <span id="sisaLimit" class="text-lg font-bold text-yellow-300">Rp 0</span>
            </div>
          </div>
        </div>

        <!-- Penarikan Details -->
        <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
          <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
            <i class="fas fa-money-bill-wave text-yellow-400 mr-2"></i>
            Detail Penarikan
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="jumlah" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Penarikan</label>
              <input type="number" id="jumlah" name="jumlah" class="w-full rounded-md p-2" required min="1000" step="1000" placeholder="Minimal Rp 1.000">
              <p class="text-xs text-gray-400 mt-1">* Maksimal sesuai sisa limit harian</p>
              <div class="mt-2 flex flex-wrap gap-2">
                <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setJumlah(2000)">Rp 2.000</button>
                <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setJumlah(5000)">Rp 5.000</button>
                <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setJumlah(10000)">Rp 10.000</button>
                <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setJumlah(15000)">Rp 15.000</button>
              </div>
            </div>
            <div>
              <label for="metode" class="block text-sm font-medium text-gray-300 mb-1">Metode Penarikan</label>
              <select id="metode" name="metode" class="w-full rounded-md p-2" required>
                <option value="">Pilih Metode</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4">
            <label for="catatan" class="block text-sm font-medium text-gray-300 mb-1">Keperluan/Catatan</label>
            <textarea id="catatan" name="catatan" rows="2" class="w-full rounded-md p-2" placeholder="Contoh: Jajan, beli buku, dll..." required></textarea>
            <div class="mt-2 flex flex-wrap gap-2">
              <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setCatatan('Jajan pagi')">Jajan pagi</button>
              <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setCatatan('Jajan siang')">Jajan siang</button>
              <button type="button" class="px-3 py-1 bg-slate-600 text-gray-200 rounded text-sm hover:bg-slate-500 transition" onclick="setCatatan('Jajan malam')">Jajan malam</button>
            </div>
          </div>
          
          <div class="mt-3 p-3 bg-red-900 bg-opacity-30 rounded border border-red-700">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-red-300">Saldo Setelah Penarikan:</span>
              <span id="saldoSetelah" class="text-xl font-bold text-red-300">Rp 0</span>
            </div>
          </div>
        </div>

        <!-- Admin Info -->
        <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
          <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
            <i class="fas fa-user-shield text-yellow-400 mr-2"></i>
            Informasi Admin
          </h3>
          
          <div>
            <label for="penerima" class="block text-sm font-medium text-gray-300 mb-1">Petugas/Admin</label>
            <input type="text" id="penerima" name="penerima" class="w-full rounded-md p-2" readonly>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end space-x-3">
          <button type="reset" class="px-6 py-3 bg-slate-700 text-gray-100 rounded-md hover:bg-slate-600 transition">
            <i class="fas fa-redo mr-2"></i> Reset
          </button>
          <button type="submit" id="submitBtn" class="px-6 py-3 bg-yellow-600 text-white rounded-md hover:bg-yellow-500 transition">
            <i class="fas fa-hand-holding-usd mr-2"></i> Proses Penarikan
          </button>
        </div>
      </form>
    </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <div class="text-center">
        <div class="w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-check text-3xl text-white"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-100 mb-2">Penarikan Berhasil!</h3>
        <div class="bg-slate-700 rounded-lg p-4 mt-4 text-left">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">ID Transaksi:</span>
              <span id="modalId" class="text-gray-200 font-mono"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Santri:</span>
              <span id="modalNama" class="text-gray-200"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Jumlah:</span>
              <span id="modalJumlah" class="text-yellow-400 font-bold"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Saldo Baru:</span>
              <span id="modalSaldo" class="text-emerald-400 font-bold"></span>
            </div>
          </div>
        </div>
        <button onclick="closeModal()" class="mt-6 w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-500 transition">
          OK
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentSaldo = 0;
    let currentLimit = 0;
    let currentPenarikanHariIni = 0;

    $(document).ready(function() {
      // Robust admin role helpers (normalize casing & trim to avoid spreadsheet mismatch)
      function _getAdminOtoritas() {
        return (sessionStorage.getItem('adminOtoritas') || '').toString().trim().toLowerCase();
      }
      const _OTORITAS = {
        SUPER: '<?= CONFIG.OTORITAS.SUPER_ADMIN ?>'.toString().trim().toLowerCase(),
        PENARIKAN: '<?= CONFIG.OTORITAS.ADMIN_PENARIKAN ?>'.toString().trim().toLowerCase(),
        PEMBIMBING: '<?= CONFIG.OTORITAS.PEMBIMBING ?>'.toString().trim().toLowerCase()
      };
      function _hasAnyRole() {
        const a = _getAdminOtoritas();
        for (let i = 0; i < arguments.length; i++) {
          if (a === arguments[i].toString().trim().toLowerCase()) return true;
        }
        return false;
      }

      // Check admin access (allow Super Admin, Admin Penarikan, or Pembimbing)
      if (!_hasAnyRole(_OTORITAS.SUPER, _OTORITAS.PENARIKAN, _OTORITAS.PEMBIMBING)) {
        alert('Anda tidak memiliki akses ke halaman ini');
        window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=dashboard';
        return;
      }

      $('#nis').select2({ placeholder: "Pilih Santri", allowClear: true, width: '100%' });

      google.script.run.withSuccessHandler(function(santri) {
        santri.forEach(s => $('#nis').append(new Option(`${s[1]} (${s[0]})`, s[0])));
      }).getActiveSantri();

      google.script.run.withSuccessHandler(function(methods) {
        methods.forEach(m => $('#metode').append(new Option(m, m)));
      }).getMetodePembayaran();

      function loadAdminName() {
        const adminNama = sessionStorage.getItem('adminNama') || 'Admin';
        $('#penerima').val(adminNama);
      }

      // Load admin name pertama kali
      loadAdminName();

      $('#nis').change(function() {
        const nis = $(this).val();
        if (!nis) {
          $('#nama').val('');
          $('#saldoSekarang, #limitHarian, #totalPenarikanHariIni, #sisaLimit, #saldoSetelah').text('Rp 0');
          currentSaldo = 0;
          currentLimit = 0;
          currentPenarikanHariIni = 0;
          return;
        }

        const selectedData = $('#nis').select2('data')[0];
        const nama = selectedData ? selectedData.text.split(' (')[0] : '';
        $('#nama').val(nama);

        // Get santri info
        google.script.run.withSuccessHandler(function(info) {
          if (info) {
            currentLimit = info.limitHarian || 0;
            $('#limitHarian').text('Rp ' + currentLimit.toLocaleString('id-ID'));
          }
        }).getSantriInfo(nis);

        // Get saldo
        google.script.run.withSuccessHandler(function(saldo) {
          currentSaldo = saldo;
          $('#saldoSekarang').text('Rp ' + saldo.toLocaleString('id-ID'));
          updateSaldoSetelah();
        }).getSaldo(nis);

        // Get penarikan hari ini
        google.script.run.withSuccessHandler(function(total) {
          currentPenarikanHariIni = total;
          $('#totalPenarikanHariIni').text('Rp ' + total.toLocaleString('id-ID'));
          const sisaLimit = Math.max(0, currentLimit - total);
          $('#sisaLimit').text('Rp ' + sisaLimit.toLocaleString('id-ID'));
          
          // Color code sisa limit
          const sisaLimitEl = $('#sisaLimit');
          sisaLimitEl.removeClass('text-yellow-300 text-red-400 text-emerald-400');
          if (sisaLimit <= 0) {
            sisaLimitEl.addClass('text-red-400');
          } else if (sisaLimit < currentLimit * 0.3) {
            sisaLimitEl.addClass('text-yellow-300');
          } else {
            sisaLimitEl.addClass('text-emerald-400');
          }
        }).getTotalPenarikanHariIni(nis);
      });

      $('#jumlah').on('input', updateSaldoSetelah);

      $('#penarikanForm').submit(function(e) {
        e.preventDefault();

        const jumlah = parseInt($('#jumlah').val());
        const sisaLimit = Math.max(0, currentLimit - currentPenarikanHariIni);

        if (jumlah > currentSaldo) {
          alert('Jumlah penarikan melebihi saldo! Saldo saat ini: Rp ' + currentSaldo.toLocaleString('id-ID'));
          return;
        }

        if (jumlah > sisaLimit) {
          alert('Jumlah penarikan melebihi sisa limit harian!\nSisa limit hari ini: Rp ' + sisaLimit.toLocaleString('id-ID') + '\n\nUntuk penarikan di atas limit, gunakan form Penarikan Khusus Pembimbing.');
          return;
        }

        const formData = {
          nis: $('#nis').val(),
          nama: $('#nama').val(),
          jumlah: jumlah,
          metode: $('#metode').val(),
          penerima: $('#penerima').val(),
          catatan: $('#catatan').val(),
          isPembimbing: false
        };

        if (!formData.nis || !formData.jumlah || !formData.metode || !formData.catatan) {
          alert('Mohon lengkapi semua field yang wajib diisi!');
          return;
        }

        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...');

        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .processPenarikan(formData);
      });

      $('#penarikanForm').on('reset', function() {
        setTimeout(() => {
          $('#nis').val(null).trigger('change');
          $('#saldoSekarang, #saldoSetelah, #limitHarian, #totalPenarikanHariIni, #sisaLimit').text('Rp 0');
          currentSaldo = 0;
          currentLimit = 0;
          currentPenarikanHariIni = 0;
          
          // Reload admin name setelah reset
          loadAdminName();
        }, 10);
      });
    });

    function updateSaldoSetelah() {
      const jumlah = parseInt($('#jumlah').val()) || 0;
      const saldoSetelah = Math.max(0, currentSaldo - jumlah);
      $('#saldoSetelah').text('Rp ' + saldoSetelah.toLocaleString('id-ID'));
    }

    function handleSuccess(response) {
      if (response.success) {
        $('#modalId').text(response.data.id);
        $('#modalNama').text(response.data.nama);
        $('#modalJumlah').text('Rp ' + response.data.jumlah.toLocaleString('id-ID'));
        $('#modalSaldo').text('Rp ' + response.data.saldoBaru.toLocaleString('id-ID'));
        $('#successModal').removeClass('hidden');
        $('#penarikanForm')[0].reset();
        $('#nis').val(null).trigger('change');
      } else {
        alert('Error: ' + response.message);
      }
      $('#submitBtn').prop('disabled', false).html('<i class="fas fa-hand-holding-usd mr-2"></i> Proses Penarikan');
    }

    function handleError(error) {
      alert('Error: ' + error.message);
      $('#submitBtn').prop('disabled', false).html('<i class="fas fa-hand-holding-usd mr-2"></i> Proses Penarikan');
    }

    function closeModal() {
      $('#successModal').addClass('hidden');
    }

    function setJumlah(amount) {
      $('#jumlah').val(amount);
      updateSaldoSetelah();
    }

    function setCatatan(text) {
      $('#catatan').val(text);
    }

    function goBack() {
      window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=dashboard';
    }
  </script>
</body>
</html>