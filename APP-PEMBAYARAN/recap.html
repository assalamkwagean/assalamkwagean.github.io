<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
            },
            indigo: {
              600: '#4f46e5',
              500: '#6366f1',
            }
          }
        }
      }
    }
  </script>
  <style>
    /* GAS Iframe and Header Adjustments */
    body {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      /* Account for GAS header */
      padding-top: 60px;
      /* Ensure minimum width for iframe */
      min-width: 320px;
      /* Prevent horizontal scroll in iframe */
      overflow-x: hidden;
    }

    /* GAS iframe container adjustments */
    .container {
      max-width: 100% !important;
      width: 100% !important;
      padding-left: 16px !important;
      padding-right: 16px !important;
    }

    /* Adjust for smaller iframe widths */
    @media (max-width: 1024px) {
      .container {
        padding-left: 12px !important;
        padding-right: 12px !important;
      }

      .bg-slate-800.rounded-lg {
        margin-left: 4px !important;
        margin-right: 4px !important;
        border-radius: 8px !important;
      }

      /* Table adjustments for iframe */
      .recap-table {
        font-size: 13px;
        min-width: 600px;
      }

      .recap-table th,
      .recap-table td {
        padding: 8px 10px;
        white-space: nowrap;
      }
    }

    input, textarea, select:not(.select2) {
      font-size: 16px !important;
      transform: scale(1);
      max-height: 44px !important;
      min-height: 44px !important;
      -webkit-appearance: none;
      appearance: none;
      border-radius: 6px !important;
    }

    .select2-container--default .select2-selection--single {
      font-size: 16px !important;
      min-height: 44px !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
      height: 44px !important;
      display: flex !important;
      align-items: center !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 44px !important;
      font-size: 16px !important;
      color: #f1f5f9 !important;
    }

    button {
      min-height: 44px;
      touch-action: manipulation;
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
    }

    .select2-container--default .select2-results__option[aria-selected="true"] {
      background-color: #4f46e5 !important;
      color: white !important;
    }

    .select2-dropdown {
      background-color: #334155 !important;
      border-color: #475569 !important;
    }

    .select2-container--default .select2-results__option {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #4f46e5 !important;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
      background-color: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
      font-size: 16px !important;
      min-height: 38px !important;
    }

    /* Table Styling */
    .recap-table {
      width: 100%;
      border-collapse: collapse;
    }

    .recap-table th, .recap-table td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #475569;
      font-size: 14px;
    }

    .recap-table th {
      background-color: #4f46e5;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
    }

    .recap-table tr:nth-child(even) {
      background-color: #334155;
    }

    .recap-table tr:hover {
      background-color: #475569;
    }

    .progress-bar {
      height: 8px;
      background-color: #475569;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      background-color: #10b981;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 6px;
    }

    .category-badge.cat-1 {
      background-color: #3b82f6;
      color: white;
    }

    .category-badge.cat-2 {
      background-color: #8b5cf6;
      color: white;
    }

    .category-badge.cat-3 {
      background-color: #ec4899;
      color: white;
    }

    /* GAS iframe specific styles */
    .gas-iframe {
      /* Additional padding for GAS header */
      padding-top: 70px !important;
      /* Ensure no horizontal overflow */
      overflow-x: hidden !important;
      /* Optimize for iframe width */
      max-width: 100vw !important;
    }

    .gas-iframe .container {
      /* Full width in iframe */
      max-width: none !important;
      width: 100% !important;
      /* Adjust padding for iframe */
      padding-left: 12px !important;
      padding-right: 12px !important;
    }

    .gas-iframe .bg-slate-800.rounded-lg {
      /* Reduce margins in iframe */
      margin-left: 2px !important;
      margin-right: 2px !important;
      /* Adjust border radius */
      border-radius: 6px !important;
    }

    @media (max-width: 767px) {
      .container {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }

      .bg-slate-800.rounded-lg {
        margin: 4px !important;
        border-radius: 8px !important;
      }

      .recap-table {
        font-size: 12px;
        min-width: 500px;
      }

      .recap-table th, .recap-table td {
        padding: 6px 4px;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #4f46e5;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6366f1;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media print {
      .no-print {
        display: none !important;
      }

      .bg-slate-800,
      .bg-slate-900 {
        background: white !important;
        color: black !important;
      }
    }

    /* PDF Preview Styling */
    #pdfContent {
      color: black !important;
      font-family: Arial, sans-serif;
    }

    #pdfContent * {
      color: inherit !important;
      box-sizing: border-box;
    }

    #pdfContent table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      font-size: 9pt;
    }

    #pdfContent th, #pdfContent td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      text-align: left;
      color: black !important; /* Memastikan teks di sel tabel berwarna hitam */
    }

    #pdfContent th {
      background-color: #3b82f6 !important;
      color: white !important;
      font-weight: bold;
    }

    #pdfContent .summary-section {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
    }

    #pdfContent .summary-section div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-slate-900 min-h-screen text-gray-100">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="bg-slate-800 rounded-lg shadow-lg p-6 border border-slate-700">
      <div class="flex flex-col items-center mb-6">
        <img id="logoImage" alt="Logo <?= CONFIG.PONDOK_NAME ?>" class="h-16 mb-3">
        <h1 class="text-2xl font-bold text-indigo-400 text-center">REKAPITULASI PEMBAYARAN</h1>
        <p class="text-gray-400 mt-1"><?= CONFIG.PONDOK_NAME ?> <?= CONFIG.PESANTREN_NAME ?></p>
      </div>
      
      <div class="mb-6 no-print">
        <label for="nisFilter" class="block text-sm font-medium text-gray-300 mb-1">Pilih Santri</label>
        <select id="nisFilter" class="mt-1 block w-full select2">
          <option value="">Pilih Santri</option>
        </select>
      </div>
      
      <div id="recapContent">
        <div class="text-center py-8">
          <i class="fas fa-user text-4xl text-gray-500 mb-4"></i>
          <p class="text-gray-400">Pilih santri untuk melihat rekapitulasi pembayaran</p>
        </div>
      </div>
      
      <!-- Modal PDF -->
      <div id="pdfModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden print:block print:bg-transparent z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto print:shadow-none print:max-w-full print:max-h-none">
          <div id="pdfContent" class="bg-white"></div>
          <div class="mt-4 flex justify-end print:hidden">
            <button id="downloadPDF" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 mr-2 flex items-center">
              <i class="fas fa-file-pdf mr-1"></i> Simpan PDF
            </button>
            <button id="closePDF" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 flex items-center">
              <i class="fas fa-times mr-1"></i> Tutup
            </button>
          </div>
        </div>
      </div>
      
      <div class="mt-6 flex justify-between no-print">
        <button onclick="goBack()" class="px-4 py-2 bg-slate-700 text-gray-100 rounded-md hover:bg-slate-600 flex items-center transition duration-150">
          <i class="fas fa-arrow-left mr-2"></i> Kembali
        </button>
        <button id="showPDF" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 flex items-center transition duration-150">
          <i class="fas fa-file-pdf mr-2"></i> Lihat & Unduh PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    let APP_CONFIG = {
      pondokName: '<?= CONFIG.PONDOK_NAME ?>',
      pesantrenName: '<?= CONFIG.PESANTREN_NAME ?>',
      academicYear: '<?= CONFIG.ACADEMIC_YEAR ?>'
    };

  let currentRecapData = null;
  let currentAdminName = '(Nama Admin)';

    function loadLogoInRecap() {
      google.script.run
        .withSuccessHandler(function(dataUrl) {
          if (dataUrl) {
            const logoElement = document.getElementById('logoImage');
            if (logoElement) {
              logoElement.src = dataUrl;
            }
          }
        })
        .getAppLogo();
    }    

    // GAS iframe detection and adjustments
    function isInGASIframe() {
      return window.self !== window.top && window.location.hostname.includes('script.google.com');
    }

    function adjustForGAS() {
      if (isInGASIframe()) {
        // Add GAS-specific class to body
        document.body.classList.add('gas-iframe');

        // Adjust viewport for iframe
        const viewport = document.querySelector('meta[name=viewport]');
        if (viewport) {
          viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no');
        }

        console.log('GAS iframe detected in recap - applying optimizations');
      }
    }

    $(document).ready(function() {
      adjustForGAS();

      $('#nisFilter').select2({
        placeholder: "Pilih Santri",
        allowClear: true
      });

      loadStudents();
      
      $('#nisFilter').change(function() {
        const nis = $(this).val();
        if (nis) {
          loadRecapData(nis);
        } else {
          resetRecapDisplay();
        }
      });
      
      $('#showPDF').click(function() {
        if (!currentRecapData) {
          alert('Pilih santri terlebih dahulu untuk melihat rekapitulasi');
          return;
        }
        preparePdfContent();
        $('#pdfModal').removeClass('hidden');
      });
      
      $('#closePDF').click(() => {
        $('#pdfModal').addClass('hidden');
      });
      
      $('#pdfModal').click(function(e) {
        if (e.target === this) {
          $(this).addClass('hidden');
        }
      });
      
      $('#downloadPDF').click(function() {
        if (!currentRecapData) {
          alert('Pilih santri terlebih dahulu!');
          return;
        }

        const downloadBtn = document.getElementById('downloadPDF');
        const originalHTML = downloadBtn.innerHTML;
        
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Memproses...';

        try {
          if (typeof jspdf === 'undefined') {
            alert('Library PDF tidak terload dengan benar');
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');

          const { nis, nama, kategori, kategori2, kategori3, tagihanGroups } = currentRecapData;
          const studentName = nama || 'Rekapitulasi';
          const studentNis = nis || '';
          const filename = `Rekapitulasi_${studentName.replace(/\s+/g, '_')}_${studentNis}.pdf`;

          // Header
          doc.setFontSize(16);
          doc.setFont('helvetica', 'bold');
          doc.text('REKAPITULASI PEMBAYARAN', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

          doc.setFontSize(11);
          doc.setFont('helvetica', 'normal');
          doc.text(`${APP_CONFIG.pondokName} ${APP_CONFIG.pesantrenName} ${APP_CONFIG.academicYear}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });

          doc.setLineWidth(0.5);
          doc.line(15, 25, 195, 25);

          // Info Santri
          doc.setFontSize(10);
          doc.text('Nama Santri', 15, 32);
          doc.text(`: ${nama}`, 50, 32);
          doc.text('NIS', 15, 37);
          doc.text(`: ${nis}`, 50, 37);
          doc.text('Kategori', 15, 42);
          doc.text(`: ${kategori}`, 50, 42);
          doc.text('Kategori-2', 15, 47);
          doc.text(`: ${kategori2}`, 50, 47);
          doc.text('Kategori-3', 15, 52);
          doc.text(`: ${kategori3}`, 50, 52);
          doc.text('Tanggal Cetak', 15, 57);
          doc.text(`: ${new Date().toLocaleDateString('id-ID')}`, 50, 57);

          let startY = 65;
          let totalTagihan = 0;
          let totalDibayarkan = 0;
          let totalPotongan = 0;

          if (tagihanGroups && tagihanGroups.length > 0) {
            tagihanGroups.forEach(group => {
              // Tambahkan header kelompok jika bukan 'Umum'
              if (group.name !== 'Umum') {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`Bulan ${group.name}`, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                startY += 3;
              }

              // Tabel untuk kelompok ini
              const tableHead = [['Jenis Tagihan', 'Jumlah Tagihan', 'Sudah Dibayar', 'Potongan', 'Sisa', 'Status']];
              const tableBody = [];

              group.tagihan.forEach(item => {
                if (item.jumlahTagihan > 0) {
                  const potongan = item.totalPotongan || 0;
                  const sisa = item.jumlahTagihan - item.sudahDibayarkan - potongan;
                  const status = sisa <= 0 ? 'LUNAS' : 'BELUM LUNAS';

                  tableBody.push([
                    item.jenis,
                    `Rp ${Number(item.jumlahTagihan).toLocaleString('id-ID')}`,
                    `Rp ${Number(item.sudahDibayarkan).toLocaleString('id-ID')}`,
                    `Rp ${Number(potongan).toLocaleString('id-ID')}`,
                    `Rp ${Number(sisa).toLocaleString('id-ID')}`,
                    status
                  ]);

                  totalTagihan += item.jumlahTagihan;
                  totalDibayarkan += item.sudahDibayarkan;
                  totalPotongan += potongan;
                }
              });

              if (tableBody.length > 0) {
                doc.autoTable({
                  head: tableHead,
                  body: tableBody,
                  startY: startY,
                  theme: 'grid',
                  headStyles: {
                    fillColor: [59, 130, 246],
                    textColor: [255, 255, 255]
                  },
                  styles: {
                    fontSize: 8,
                    cellPadding: 2
                  },
                  columnStyles: {
                    1: { halign: 'right' },
                    2: { halign: 'right' },
                    3: { halign: 'right' },
                    4: { halign: 'right' },
                    5: { halign: 'center' }
                  }
                });

                startY = doc.autoTable.previous.finalY + 10;
              }
            });

            // Summary dengan total potongan
            const totalSisa = totalTagihan - totalDibayarkan - totalPotongan;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Total Tagihan', 15, startY);
            doc.text(`: Rp ${totalTagihan.toLocaleString('id-ID')}`, 60, startY);

            doc.text('Total Dibayarkan', 15, startY + 5);
            doc.text(`: Rp ${totalDibayarkan.toLocaleString('id-ID')}`, 60, startY + 5);

            doc.text('Total Potongan', 15, startY + 10);
            doc.text(`: Rp ${totalPotongan.toLocaleString('id-ID')}`, 60, startY + 10);

            doc.text('Sisa Tagihan', 15, startY + 15);
            doc.text(`: Rp ${totalSisa.toLocaleString('id-ID')}`, 60, startY + 15);

            // Tanda tangan
            const signatureY = startY + 20;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Hormat kami,', doc.internal.pageSize.getWidth() - 50, signatureY, { align: 'center' });
            doc.text(currentAdminName || '(Nama Admin)', doc.internal.pageSize.getWidth() - 50, signatureY + 20, { align: 'center' });
            doc.text('Admin', doc.internal.pageSize.getWidth() - 50, signatureY + 25, { align: 'center' });

          } else {
            doc.text('Tidak ada data tagihan', 15, 65);
          }

          doc.save(filename);

        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('Error generating PDF: ' + error.message);
        } finally {
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = originalHTML;
        }
      });

      // Load admin name saved at login (login.html stores it in sessionStorage)
      try {
        var storedAdmin = sessionStorage.getItem('adminNama');
        if (storedAdmin) currentAdminName = storedAdmin;
      } catch (e) {
        // ignore if sessionStorage not available
      }

      loadLogoInRecap();      
    });

    function loadStudents() {
      google.script.run
        .withSuccessHandler(function(students) {
          students.forEach(student => {
            $('#nisFilter').append(new Option(`${student[1]} (${student[0]})`, student[0]));
          });
        })
        .getActiveStudents();
    }

    function loadRecapData(nis) {
      $('#recapContent').html(`
        <div class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-4xl text-indigo-400 mb-4"></i>
          <p class="text-gray-400">Memuat data rekapitulasi...</p>
        </div>
      `);

      google.script.run
        .withSuccessHandler(function(recapData) {
          currentRecapData = recapData;
          displayRecapData(recapData);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading recap data:', error);
          $('#recapContent').html(`
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
              <p class="text-red-400">Gagal memuat data rekapitulasi</p>
              <p class="text-gray-400 text-sm mt-2">${error.message || 'Silakan coba lagi'}</p>
            </div>
          `);
        })
        .getRecapDetail(nis);
    }

    function displayRecapData(recapData) {
       let html = `
         <div id="studentInfo" class="mb-4 p-4 bg-slate-700 rounded-lg">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div>
               <span class="font-semibold">NIS:</span>
               <span id="recapNis">${recapData.nis}</span>
             </div>
             <div>
               <span class="font-semibold">Nama:</span>
               <span id="recapNama">${recapData.nama}</span>
             </div>
             <div>
               <span class="font-semibold">Kategori:</span>
               <span id="recapKategori">${recapData.kategori}</span>
               <span class="category-badge cat-1">CAT-1</span>
             </div>
             <div>
               <span class="font-semibold">Kategori-2:</span>
               <span id="recapKategori2">${recapData.kategori2}</span>
               <span class="category-badge cat-2">CAT-2</span>
             </div>
             <div>
               <span class="font-semibold">Kategori-3:</span>
               <span id="recapKategori3">${recapData.kategori3}</span>
               <span class="category-badge cat-3">CAT-3</span>
             </div>
           </div>
         </div>

         <div class="overflow-x-auto">
           <table class="recap-table">
             <thead>
               <tr>
                 <th>Jenis Tagihan</th>
                 <th>Jumlah Tagihan</th>
                 <th>Sudah Dibayarkan</th>
                 <th>Potongan</th>
                 <th>Sisa Tagihan</th>
                 <th>Status</th>
               </tr>
             </thead>
             <tbody>
       `;

       let totalTagihan = 0;
       let totalDibayarkan = 0;
       let totalPotongan = 0;
       let totalSisa = 0;

       if (recapData.tagihanGroups && recapData.tagihanGroups.length > 0) {
         recapData.tagihanGroups.forEach(group => {
           // Tambahkan header kelompok jika bukan 'Umum'
           if (group.name !== 'Umum') {
             html += `
               <tr>
                 <td colspan="6" style="background-color: #475569; font-weight: bold; text-align: center; padding: 6px; font-size: 12px;">
                   Bulan ${group.name}
                 </td>
               </tr>
             `;
           }

           group.tagihan.forEach(tagihan => {
             if (tagihan.jumlahTagihan > 0) {
               const potongan = tagihan.totalPotongan || 0;
               const sisa = tagihan.jumlahTagihan - tagihan.sudahDibayarkan - potongan;
               const persentase = ((tagihan.sudahDibayarkan + potongan) / tagihan.jumlahTagihan) * 100;
               const status = sisa <= 0 ? 'LUNAS' : 'BELUM LUNAS';

               totalTagihan += tagihan.jumlahTagihan;
               totalDibayarkan += tagihan.sudahDibayarkan;
               totalPotongan += potongan;
               totalSisa += sisa;

               html += `
                 <tr>
                   <td>${tagihan.jenis}</td>
                   <td>Rp${Number(tagihan.jumlahTagihan).toLocaleString('id-ID')}</td>
                   <td>Rp${Number(tagihan.sudahDibayarkan).toLocaleString('id-ID')}</td>
                   <td>Rp${Number(potongan).toLocaleString('id-ID')}</td>
                   <td>Rp${Number(sisa).toLocaleString('id-ID')}</td>
                   <td>
                     <div class="flex items-center">
                       <span class="${status === 'LUNAS' ? 'text-green-400' : 'text-yellow-400'} font-medium">${status}</span>
                       ${sisa > 0 ? `
                       <div class="ml-2 text-xs text-gray-400">${Math.round(persentase)}%</div>
                       <div class="ml-2 progress-bar" style="width: 60px;">
                         <div class="progress-fill" style="width: ${persentase}%"></div>
                       </div>
                       ` : ''}
                     </div>
                   </td>
                 </tr>
               `;
             }
           });
         });
       }

       html += `
             </tbody>
           </table>
         </div>

         <div class="mt-6 p-4 bg-slate-700 rounded-lg">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div>
               <span class="font-semibold">Total Tagihan:</span>
               <span id="totalTagihan">Rp ${Number(totalTagihan).toLocaleString('id-ID')}</span>
             </div>
             <div>
               <span class="font-semibold">Total Dibayarkan:</span>
               <span id="totalDibayarkan">Rp ${Number(totalDibayarkan).toLocaleString('id-ID')}</span>
             </div>
             <div>
               <span class="font-semibold">Total Potongan:</span>
               <span id="totalPotongan" class="text-purple-400">Rp ${Number(totalPotongan).toLocaleString('id-ID')}</span>
             </div>
             <div>
               <span class="font-semibold">Sisa Tagihan:</span>
               <span id="sisaTagihan" class="${totalSisa > 0 ? 'text-yellow-400' : 'text-green-400'}">Rp ${Number(totalSisa).toLocaleString('id-ID')}</span>
             </div>
           </div>
         </div>
       `;

       if (totalTagihan === 0) {
         html = `
           <div class="text-center py-8">
             <i class="fas fa-receipt text-4xl text-gray-500 mb-4"></i>
             <p class="text-gray-400">Tidak ada data tagihan untuk santri ini</p>
           </div>
         `;
       }

       $('#recapContent').html(html);
     }

    function preparePdfContent() {
       if (!currentRecapData) return;

       const { nis, nama, kategori, kategori2, kategori3, tagihanGroups } = currentRecapData;

       let totalTagihan = 0;
       let totalDibayarkan = 0;
       let totalPotongan = 0;
       let totalSisa = 0;

       if (tagihanGroups && tagihanGroups.length > 0) {
         tagihanGroups.forEach(group => {
           group.tagihan.forEach(tagihanItem => {
             if (tagihanItem.jumlahTagihan > 0) {
               const potongan = tagihanItem.totalPotongan || 0;
               totalTagihan += tagihanItem.jumlahTagihan;
               totalDibayarkan += tagihanItem.sudahDibayarkan;
               totalPotongan += potongan;
               totalSisa += (tagihanItem.jumlahTagihan - tagihanItem.sudahDibayarkan - potongan);
             }
           });
         });
       }

       let pdfHtml = `
         <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
           <h2 style="font-weight: bold; margin: 0; font-size: 14pt;">REKAPITULASI PEMBAYARAN</h2>
           <p style="margin: 5px 0; font-size: 10pt;">${APP_CONFIG.pondokName} ${APP_CONFIG.pesantrenName} ${APP_CONFIG.academicYear}</p>
         </div>

         <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; font-size: 10pt;">
           <table style="width: 100%; border-collapse: collapse;">
             <tr>
               <td style="width: 25%; padding: 2px 0; border: none;">Nama Santri</td>
               <td style="width: 5%; padding: 2px 0; border: none;">:</td>
               <td style="width: 70%; padding: 2px 0; border: none;"><strong>${nama}</strong></td>
             </tr>
             <tr>
               <td style="padding: 2px 0; border: none;">NIS</td>
               <td style="padding: 2px 0; border: none;">:</td>
               <td style="padding: 2px 0; border: none;">${nis}</td>
             </tr>
             <tr>
               <td style="padding: 2px 0; border: none;">Kategori</td>
               <td style="padding: 2px 0; border: none;">:</td>
               <td style="padding: 2px 0; border: none;">${kategori}</td>
             </tr>
             <tr>
               <td style="padding: 2px 0; border: none;">Kategori-2</td>
               <td style="padding: 2px 0; border: none;">:</td>
               <td style="padding: 2px 0; border: none;">${kategori2}</td>
             </tr>
             <tr>
               <td style="padding: 2px 0; border: none;">Kategori-3</td>
               <td style="padding: 2px 0; border: none;">:</td>
               <td style="padding: 2px 0; border: none;">${kategori3}</td>
             </tr>
             <tr>
               <td style="padding: 2px 0; border: none;">Tanggal Cetak</td>
               <td style="padding: 2px 0; border: none;">:</td>
               <td style="padding: 2px 0; border: none;">${new Date().toLocaleDateString('id-ID')}</td>
             </tr>
           </table>
         </div>
       `;

       if (tagihanGroups && tagihanGroups.length > 0 && totalTagihan > 0) {
         tagihanGroups.forEach(group => {
           // Tambahkan header kelompok jika bukan 'Umum'
           if (group.name !== 'Umum') {
             pdfHtml += `
               <div style="background-color: #e5e7eb; padding: 4px; margin: 4px 0; font-weight: bold; text-align: center; border: 1px solid #d1d5db; font-size: 11pt;">
                 Bulan ${group.name}
               </div>
             `;
           }

           pdfHtml += `
             <table style="width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 9pt;">
               <thead>
                 <tr>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Jenis Tagihan</th>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Jumlah Tagihan</th>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Sudah Dibayar</th>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Potongan</th>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Sisa</th>
                   <th style="background-color: #3b82f6; color: white; padding: 6px 4px; text-align: left; border: 1px solid #ddd;">Status</th>
                 </tr>
               </thead>
               <tbody>
           `;

           group.tagihan.forEach(tagihanItem => {
             if (tagihanItem.jumlahTagihan > 0) {
               const potongan = tagihanItem.totalPotongan || 0;
               const sisa = tagihanItem.jumlahTagihan - tagihanItem.sudahDibayarkan - potongan;
               const status = sisa <= 0 ? 'LUNAS' : 'BELUM LUNAS';
               const statusColor = status === 'BELUM LUNAS' ? 'color: red;' : '';

               pdfHtml += `
                 <tr>
                   <td style="padding: 5px 4px; border: 1px solid #ddd;">${tagihanItem.jenis}</td>
                   <td style="padding: 5px 4px; border: 1px solid #ddd;">Rp${Number(tagihanItem.jumlahTagihan).toLocaleString('id-ID')}</td>
                   <td style="padding: 5px 4px; border: 1px solid #ddd;">Rp${Number(tagihanItem.sudahDibayarkan).toLocaleString('id-ID')}</td>
                   <td style="padding: 5px 4px; border: 1px solid #ddd;">Rp${Number(potongan).toLocaleString('id-ID')}</td>
                   <td style="padding: 5px 4px; border: 1px solid #ddd;">Rp${Number(sisa).toLocaleString('id-ID')}</td>
                   <td style="padding: 5px 4px; border: 1px solid #ddd; ${statusColor}">${status}</td>
                 </tr>
               `;
             }
           });

           pdfHtml += `
               </tbody>
             </table>
           `;
         });

         pdfHtml += `
           <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 10pt;">
             <table style="width: 100%; border-collapse: collapse;">
               <tr>
                 <td style="width: 30%; padding: 2px 0; border: none; font-weight: bold;">Total Tagihan</td>
                 <td style="width: 5%; padding: 2px 0; border: none; font-weight: bold;">:</td>
                 <td style="width: 65%; padding: 2px 0; border: none; font-weight: bold;">Rp ${totalTagihan.toLocaleString('id-ID')}</td>
               </tr>
               <tr>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Total Dibayarkan</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">:</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Rp ${totalDibayarkan.toLocaleString('id-ID')}</td>
               </tr>
               <tr>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Total Potongan</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">:</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Rp ${totalPotongan.toLocaleString('id-ID')}</td>
               </tr>
               <tr>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Sisa Tagihan</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">:</td>
                 <td style="padding: 2px 0; border: none; font-weight: bold;">Rp ${totalSisa.toLocaleString('id-ID')}</td>
               </tr>
             </table>
           </div>
         `;
       } else {
         pdfHtml += `
           <div style="text-align: center; padding: 20px; color: #666;">
             <p>Tidak ada data tagihan untuk santri ini</p>
           </div>
         `;
       }

       pdfHtml += `
         <div style="margin-top: 30px; text-align: right; font-size: 10pt;">
           <p style="margin-bottom: 30px;">Hormat kami,</p>
           <p style="margin: 0; font-weight: bold;">${currentAdminName || '(Nama Admin)'}</p>
           <p style="margin: 0;">Admin</p>
         </div>
         <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; text-align: center; font-size: 8pt; color: #666;">
           <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
           <p>Rekapitulasi ini adalah dokumen resmi ${APP_CONFIG.pondokName}</p>
         </div>
       `;

       $('#pdfContent').html(pdfHtml);
     }

    function resetRecapDisplay() {
      $('#recapContent').html(`
        <div class="text-center py-8">
          <i class="fas fa-user text-4xl text-gray-500 mb-4"></i>
          <p class="text-gray-400">Pilih santri untuk melihat rekapitulasi pembayaran</p>
        </div>
      `);
      currentRecapData = null;
    }

    function goBack() {
      window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=form';
    }
  </script>
</body>
</html>