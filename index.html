<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabungan Santri - Login</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <div class="login-card">
            <div class="logo-section">
                <div class="logo">
                    <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                        <circle cx="30" cy="30" r="28" fill="#4F46E5" opacity="0.1"/>
                        <path d="M30 15C21.716 15 15 21.716 15 30C15 38.284 21.716 45 30 45C38.284 45 45 38.284 45 30C45 21.716 38.284 15 30 15ZM30 27C31.657 27 33 28.343 33 30C33 31.657 31.657 33 30 33C28.343 33 27 31.657 27 30C27 28.343 28.343 27 30 27Z" fill="#4F46E5"/>
                    </svg>
                </div>
                <h1>Tabungan Santri</h1>
                <p class="subtitle">Masuk ke akun Anda</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="identifier">NIS / Email</label>
                    <select id="identifier" required>
                        <option value="">Pilih Santri atau masukkan email</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Masukkan password" autocomplete="current-password">
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span class="btn-text">Masuk</span>
                    <span class="spinner" style="display: none;"></span>
                </button>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </form>

            <div class="footer-text">
                <p>Untuk bantuan, hubungi administrator</p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="config.js"></script>
    <script>
        $(document).ready(function() {
            const identifierSelect = $('#identifier');

            identifierSelect.select2({
                placeholder: 'Pilih Santri atau masukkan email',
                allowClear: true,
                width: '100%',
                tags: true, // Memungkinkan input email manual
                createTag: function (params) {
                    var term = $.trim(params.term);
                    if (term === '' || term.indexOf('@') === -1) {
                        return null;
                    }
                    return {
                        id: term,
                        text: term
                    };
                }
            });

            // Load data santri
            loadSantriData().then(santriData => {
                santriData.forEach(santri => {
                    const option = new Option(`${santri.nis} - ${santri.nama}`, santri.nis, false, false);
                    identifierSelect.append(option);
                });
                identifierSelect.trigger('change');
            });
        });

        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const identifier = $('#identifier').val();
            const password = document.getElementById('password').value;

            // Validasi input
            if (!identifier || !password) {
                errorMessage.textContent = 'NIS/Email dan password harus diisi';
                errorMessage.style.display = 'block';
                return;
            }

            // Show loading
            loginBtn.disabled = true;
            loginBtn.querySelector('.btn-text').style.display = 'none';
            loginBtn.querySelector('.spinner').style.display = 'inline-block';
            errorMessage.style.display = 'none';

            try {
                const requestBody = {
                    identifier: identifier.trim(),
                    password: password
                };

                console.log('Mengirim permintaan login dengan data:', JSON.stringify(requestBody, null, 2));

                const response = await fetch(`${API_URL}?action=login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                console.log('Hasil login:', result);

                if (result.success) {
                    // Simpan data user
                    localStorage.setItem('userData', JSON.stringify(result.data));
                    localStorage.setItem('userType', result.userType);

                    // Redirect berdasarkan user type
                    switch(result.userType) {
                        case 'admin':
                            window.location.href = 'admin.html';
                            break;
                        case 'santri':
                            window.location.href = 'santri.html';
                            break;
                        case 'pembimbing':
                            window.location.href = 'pembimbing.html';
                            break;
                        default:
                            errorMessage.textContent = 'Tipe user tidak dikenali';
                            errorMessage.style.display = 'block';
                    }
                } else {
                    errorMessage.textContent = result.message || 'Login gagal. Periksa NIS/Email dan password Anda.';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                handleApiError(error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.querySelector('.btn-text').style.display = 'inline';
                loginBtn.querySelector('.spinner').style.display = 'none';
            }
        });
    </script>
    </script>
</body>
</html>