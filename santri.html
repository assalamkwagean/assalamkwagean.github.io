<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Santri - Tabungan Santri</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="#" class="navbar-brand">
                <i class="fas fa-mosque"></i> Tabungan Santri
            </a>
            <div class="navbar-nav">
                <span id="userInfo" class="text-gray-600"></span>
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Saldo Card -->
        <div class="balance-card card slide-in">
            <div class="balance-label">Total Saldo</div>
            <div id="saldoAmount" class="balance-amount">
                <div class="spinner"></div>
            </div>
            <div class="balance-info">
                <span>Update terakhir: <span id="lastUpdate">-</span></span>
                <span id="limitHarian"></span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 mt-4">
            <div class="card">
                <h3><i class="fas fa-wallet"></i> Mutasi Terakhir</h3>
                <div id="mutasiList" class="transaction-list mt-3">
                    <div class="text-center text-gray-500">
                        <div class="spinner"></div>
                        Memuat data...
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Ringkasan</h3>
                <div class="grid grid-cols-2 gap-4 mt-3">
                    <div class="stat-card">
                        <i class="fas fa-arrow-up text-success"></i>
                        <div>
                            <div class="stat-label">Total Top Up</div>
                            <div id="totalTopUp" class="stat-value">-</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-arrow-down text-danger"></i>
                        <div>
                            <div class="stat-label">Total Penarikan</div>
                            <div id="totalPenarikan" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riwayat Transaksi -->
        <div class="card mt-4">
            <div class="card-header">
                <h3><i class="fas fa-history"></i> Riwayat Transaksi</h3>
                <div class="card-actions">
                    <button class="btn btn-outline" onclick="downloadRiwayat()">
                        <i class="fas fa-download"></i> Unduh
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis</th>
                            <th>Jumlah</th>
                            <th>Metode</th>
                            <th>Penerima</th>
                            <th>Catatan</th>
                        </tr>
                    </thead>
                    <tbody id="riwayatTable">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner"></div>
                                Memuat data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination mt-4" id="pagination"></div>
        </div>
    </div>

    <script src="assets/js/utils.js"></script>
    <script>
        // Check authentication
        if (!checkAuth(['santri'])) {
            window.location.href = 'index.html';
        }

        const userData = getUserData();
        document.getElementById('userInfo').textContent = `${userData.nama} (${userData.nis})`;
        document.getElementById('limitHarian').textContent = `Limit Harian: ${formatCurrency(userData.limitHarian)}`;

        // Load data
        async function loadData() {
            try {
                // Load saldo
                const saldoResult = await callAPI('getSaldo', { nis: userData.nis });
                if (saldoResult.success) {
                    document.getElementById('saldoAmount').textContent = formatCurrency(saldoResult.data.saldo);
                    document.getElementById('lastUpdate').textContent = formatDate(new Date());
                }

                // Load riwayat
                loadRiwayat();
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            }
        }

        // Load riwayat transaksi with pagination
        async function loadRiwayat(page = 1) {
            try {
                const result = await callAPI('getRiwayat', { 
                    nis: userData.nis,
                    page: page,
                    limit: 10
                });

                if (result.success) {
                    updateRiwayatTable(result.data);
                    updatePagination(result.data.pagination);
                    updateRingkasan(result.data.transactions);
                }
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            }
        }

        function updateRiwayatTable(data) {
            const tbody = document.getElementById('riwayatTable');
            tbody.innerHTML = '';

            data.transactions.forEach(trans => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(trans.tanggal)}</td>
                    <td>
                        <span class="badge ${trans.type === 'topup' ? 'badge-success' : 'badge-danger'}">
                            ${trans.type === 'topup' ? 'Top Up' : 'Penarikan'}
                        </span>
                    </td>
                    <td class="text-${trans.type === 'topup' ? 'success' : 'danger'}">
                        ${formatCurrency(trans.jumlah)}
                    </td>
                    <td>${trans.metode}</td>
                    <td>${trans.penerima}</td>
                    <td>${trans.catatan || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (pagination.totalPages <= 1) return;

            // Previous button
            if (pagination.hasPrevPage) {
                container.appendChild(createPaginationButton(
                    pagination.currentPage - 1,
                    'Sebelumnya',
                    'fas fa-chevron-left'
                ));
            }

            // Page numbers
            for (let i = 1; i <= pagination.totalPages; i++) {
                container.appendChild(createPaginationButton(
                    i,
                    i.toString(),
                    null,
                    i === pagination.currentPage
                ));
            }

            // Next button
            if (pagination.hasNextPage) {
                container.appendChild(createPaginationButton(
                    pagination.currentPage + 1,
                    'Selanjutnya',
                    'fas fa-chevron-right'
                ));
            }
        }

        function createPaginationButton(page, text, icon, isActive = false) {
            const button = document.createElement('button');
            button.className = `btn ${isActive ? 'btn-primary' : 'btn-outline'}`;
            button.onclick = () => loadRiwayat(page);
            
            if (icon) {
                button.innerHTML = `<i class="${icon}"></i> ${text}`;
            } else {
                button.textContent = text;
            }
            
            return button;
        }

        function updateRingkasan(transactions) {
            let totalTopUp = 0;
            let totalPenarikan = 0;

            transactions.forEach(trans => {
                if (trans.type === 'topup') {
                    totalTopUp += trans.jumlah;
                } else {
                    totalPenarikan += trans.jumlah;
                }
            });

            document.getElementById('totalTopUp').textContent = formatCurrency(totalTopUp);
            document.getElementById('totalPenarikan').textContent = formatCurrency(totalPenarikan);
        }

        async function downloadRiwayat() {
            try {
                const result = await callAPI('getRiwayat', { 
                    nis: userData.nis,
                    format: 'csv'
                });

                if (result.success) {
                    const blob = new Blob([result.data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `riwayat_transaksi_${userData.nis}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                }
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            }
        }

        // Initial load
        loadData();

        // Setup real-time updates if available
        if (typeof RealtimeUpdates !== 'undefined') {
            new RealtimeUpdates();
        }
    </script>
</body>
</html>