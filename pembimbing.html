<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pembimbing - Tabungan Santri</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="#" class="navbar-brand">
                <i class="fas fa-mosque"></i> Tabungan Santri
            </a>
            <div class="navbar-nav">
                <span id="userInfo" class="text-gray-600"></span>
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Santri List -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-users"></i> Daftar Santri</h3>
                <div class="card-actions">
                    <div class="search-box">
                        <input type="text" id="searchInput" class="form-control" placeholder="Cari santri...">
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>NIS</th>
                            <th>Nama</th>
                            <th>Limit Harian</th>
                            <th>Saldo</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="santriTable">
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="spinner"></div>
                                Memuat data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Penarikan Khusus Form (Hidden by default) -->
        <div id="penarikanKhususForm" class="card mt-4" style="display: none;">
            <h3><i class="fas fa-money-bill-wave"></i> Penarikan Khusus</h3>
            <form id="formPenarikanKhusus" class="mt-3">
                <input type="hidden" id="selectedNis">
                <div class="form-group">
                    <label for="namaSantri">Nama Santri</label>
                    <input type="text" id="namaSantri" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="jumlahPenarikan">Jumlah Penarikan</label>
                    <input type="number" id="jumlahPenarikan" class="form-control" required min="1000">
                </div>
                <div class="form-group">
                    <label for="metodePenarikan">Metode</label>
                    <select id="metodePenarikan" class="form-control" required>
                        <option value="cash">Cash</option>
                        <option value="transfer">Transfer Bank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="catatanPenarikan">Catatan</label>
                    <textarea id="catatanPenarikan" class="form-control" required
                        placeholder="Berikan alasan penarikan khusus..."></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-danger">
                        <span class="btn-text">
                            <i class="fas fa-check-circle"></i> Proses Penarikan Khusus
                        </span>
                        <span class="spinner"></span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="hidePenarikanForm()">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </form>
        </div>

        <!-- Detail Santri Modal -->
        <div id="detailModal" class="modal" style="display: none;">
            <div class="modal-content card">
                <div class="modal-header">
                    <h3><i class="fas fa-user"></i> Detail Santri</h3>
                    <button class="btn-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="detailContent"></div>
                    <div id="riwayatTransaksi" class="mt-4">
                        <h4>Riwayat Transaksi</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Jenis</th>
                                        <th>Jumlah</th>
                                        <th>Metode</th>
                                        <th>Catatan</th>
                                    </tr>
                                </thead>
                                <tbody id="riwayatTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer" style="display: none;"></div>

    <script src="assets/js/utils.js"></script>
    <script>
        // Check authentication
        if (!checkAuth(['pembimbing'])) {
            window.location.href = 'index.html';
        }

        const userData = getUserData();
        document.getElementById('userInfo').textContent = `${userData.nama} (Pembimbing)`;

        // Load santri list
        loadSantriList();

        async function loadSantriList() {
            try {
                const result = await callAPI('getSantriList', { 
                    pembimbingId: userData.id 
                });

                if (result.success) {
                    updateSantriTable(result.data);
                }
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            }
        }

        function updateSantriTable(santriList) {
            const tbody = document.getElementById('santriTable');
            tbody.innerHTML = '';

            santriList.forEach(santri => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${santri.nis}</td>
                    <td>${santri.nama}</td>
                    <td>${formatCurrency(santri.limitHarian)}</td>
                    <td>${formatCurrency(santri.saldo)}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="showDetail('${santri.nis}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="showPenarikanForm('${santri.nis}', '${santri.nama}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchValue = e.target.value.toLowerCase();
            const rows = document.getElementById('santriTable').getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        });

        // Show penarikan khusus form
        function showPenarikanForm(nis, nama) {
            document.getElementById('selectedNis').value = nis;
            document.getElementById('namaSantri').value = nama;
            document.getElementById('penarikanKhususForm').style.display = 'block';
            document.getElementById('jumlahPenarikan').focus();
        }

        function hidePenarikanForm() {
            document.getElementById('penarikanKhususForm').style.display = 'none';
            document.getElementById('formPenarikanKhusus').reset();
        }

        // Handle penarikan khusus
        document.getElementById('formPenarikanKhusus').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');

            try {
                showLoading(submitBtn, true);

                const data = {
                    pembimbingId: userData.id,
                    nis: form.selectedNis.value,
                    jumlah: parseInt(form.jumlahPenarikan.value),
                    metode: form.metodePenarikan.value,
                    catatan: form.catatanPenarikan.value,
                    penerima: userData.nama
                };

                const result = await callAPI('penarikanKhusus', data);

                if (result.success) {
                    showMessage('messageContainer', 'Penarikan khusus berhasil diproses', 'success');
                    hidePenarikanForm();
                    loadSantriList();
                } else {
                    showMessage('messageContainer', result.message, 'error');
                }
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            } finally {
                showLoading(submitBtn, false);
            }
        });

        // Show santri detail
        async function showDetail(nis) {
            try {
                const result = await callAPI('getSantriDetail', { 
                    pembimbingId: userData.id,
                    nis: nis
                });

                if (result.success) {
                    const { santri, riwayat } = result.data;
                    
                    document.getElementById('detailContent').innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="detail-item">
                                <label>NIS</label>
                                <div>${santri.nis}</div>
                            </div>
                            <div class="detail-item">
                                <label>Nama</label>
                                <div>${santri.nama}</div>
                            </div>
                            <div class="detail-item">
                                <label>Limit Harian</label>
                                <div>${formatCurrency(santri.limitHarian)}</div>
                            </div>
                            <div class="detail-item">
                                <label>Saldo</label>
                                <div>${formatCurrency(santri.saldo)}</div>
                            </div>
                        </div>
                    `;

                    updateRiwayatTable(riwayat);
                    document.getElementById('detailModal').style.display = 'block';
                }
            } catch (error) {
                showMessage('messageContainer', error.message, 'error');
            }
        }

        function updateRiwayatTable(riwayat) {
            const tbody = document.getElementById('riwayatTable');
            tbody.innerHTML = '';

            riwayat.forEach(trans => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(trans.tanggal)}</td>
                    <td>
                        <span class="badge ${trans.type === 'topup' ? 'badge-success' : 'badge-danger'}">
                            ${trans.type === 'topup' ? 'Top Up' : 'Penarikan'}
                        </span>
                    </td>
                    <td class="text-${trans.type === 'topup' ? 'success' : 'danger'}">
                        ${formatCurrency(trans.jumlah)}
                    </td>
                    <td>${trans.metode}</td>
                    <td>${trans.catatan || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>