<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembimbing Dashboard - Tabungan Santri</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body class="dashboard-container">
    <div class="dashboard-header">
        <h2>Dashboard Pembimbing</h2>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">P</div>
            <div class="user-details">
                <h3 id="userName">Pembimbing</h3>
                <p>Penarikan Khusus</p>
            </div>
            <button onclick="logout()" class="btn btn-secondary" style="width: auto; padding: 8px 16px;">Keluar</button>
        </div>
    </div>

    <div class="container" style="padding-top: 0;">
        <div style="width: 100%;">
            <div class="card">
                <div class="card-header">
                    <h3>Form Penarikan Khusus</h3>
                    <p style="color: var(--gray-500); font-size: 13px; margin-top: 8px;">
                        Penarikan khusus dapat melebihi limit harian santri
                    </p>
                </div>
                <form id="penarikanKhususForm">
                    <div class="form-group">
                        <label for="nis">NIS Santri</label>
                        <select id="nis" required>
                            <option value="">Memuat data santri...</option>
                        </select>
                    </div>
                    
                    <div id="santriInfo" style="display: none; background: var(--gray-50); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--gray-700); margin-bottom: 8px;">Informasi Santri</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <div>
                                <p style="font-size: 12px; color: var(--gray-500);">Nama</p>
                                <p style="font-weight: 600; font-size: 14px;" id="infoNama">-</p>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: var(--gray-500);">Saldo Tersedia</p>
                                <p style="font-weight: 600; font-size: 14px; color: var(--primary-color);" id="infoSaldo">Rp 0</p>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: var(--gray-500);">Limit Harian</p>
                                <p style="font-weight: 600; font-size: 14px;" id="infoLimit">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="jumlah">Jumlah Penarikan (Rp)</label>
                        <input type="number" id="jumlah" required min="1000" placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="metode">Metode Penarikan</label>
                        <select id="metode" required>
                            <option value="">Pilih Metode</option>
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer">Transfer Bank</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="penerima">Diserahkan Kepada</label>
                        <input type="text" id="penerima" required placeholder="Nama penerima">
                    </div>
                    
                    <div class="form-group">
                        <label for="catatan">Catatan / Keperluan</label>
                        <textarea id="catatan" required placeholder="Jelaskan keperluan penarikan khusus ini"></textarea>
                    </div>

                    <div style="background: #FEF3C7; border-left: 4px solid var(--warning-color); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="font-size: 13px; color: #92400E;">
                            ‚ö†Ô∏è <strong>Peringatan:</strong> Penarikan khusus dapat melebihi limit harian santri. Pastikan keperluan penarikan telah diverifikasi dengan baik.
                        </p>
                    </div>

                    <button type="submit" class="btn btn-danger">
                        <span class="btn-text">Proses Penarikan Khusus</span>
                        <span class="spinner" style="display: none;"></span>
                    </button>
                    <div id="message" style="display: none;"></div>
                </form>
            </div>

            <!-- Riwayat Penarikan Khusus -->
            <div class="card">
                <div class="card-header">
                    <h3>Riwayat Penarikan Khusus</h3>
                    <button onclick="loadRiwayat()" class="btn btn-secondary" style="width: auto; padding: 8px 16px;">
                        üîÑ Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>NIS</th>
                                <th>Nama</th>
                                <th>Jumlah</th>
                                <th>Metode</th>
                                <th>Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="riwayatTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <p style="color: var(--gray-500);">Belum ada riwayat penarikan khusus</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Check auth
        checkAuth(['pembimbing']);

        const userData = getUserData();
        document.getElementById('userName').textContent = userData.nama;
        document.getElementById('userAvatar').textContent = userData.nama.charAt(0).toUpperCase();

        // Initialize Select2 for NIS selection (filtered by pembimbing)
        initializeNisSelect(document.getElementById('nis'), userData.nama);

        // Check NIS ketika select berubah
        document.getElementById('nis').addEventListener('change', (e) => {
            checkSantri(e.target.value);
        });

        async function checkSantri(nis) {
            if (!nis) {
                document.getElementById('santriInfo').style.display = 'none';
                return;
            }

            try {
                // Get santri data
                const santriResponse = await fetch(`${API_URL}?action=getDataSantri`, {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                const santriResult = await santriResponse.json();
                
                const santri = santriResult.data.find(s => s.nis === nis);
                
                if (santri) {
                    // Validasi pembimbing
                    if (santri.pembimbing !== userData.nama) {
                        document.getElementById('santriInfo').style.display = 'none';
                        showMessage('message', 'Anda bukan pembimbing santri ini', 'error');
                        return;
                    }

                    // Get saldo
                    const saldoResponse = await fetch(`${API_URL}?action=getSaldo`, {
                        method: 'POST',
                        body: JSON.stringify({ nis: nis })
                    });
                    const saldoResult = await saldoResponse.json();

                    // Tampilkan info santri
                    document.getElementById('infoNama').textContent = santri.nama;
                    document.getElementById('infoSaldo').textContent = formatCurrency(saldoResult.data.saldo);
                    document.getElementById('infoLimit').textContent = formatCurrency(santri.limitHarian);
                    document.getElementById('santriInfo').style.display = 'block';
                } else {
                    document.getElementById('santriInfo').style.display = 'none';
                }
            } catch (error) {
                console.error(error);
            }
        }

        // Form submission
        document.getElementById('penarikanKhususForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = e.target.querySelector('button[type="submit"]');
            showLoading(btn);
            
            const data = {
                nis: document.getElementById('nis').value,
                jumlah: parseInt(document.getElementById('jumlah').value),
                metode: document.getElementById('metode').value,
                penerima: document.getElementById('penerima').value,
                catatan: document.getElementById('catatan').value,
                pembimbingNama: userData.nama
            };
            
            try {
                const response = await fetch(`${API_URL}?action=penarikanKhusus`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('message', 'Penarikan khusus berhasil diproses!', 'success');
                    e.target.reset();
                    document.getElementById('santriInfo').style.display = 'none';
                    loadRiwayat();
                } else {
                    showMessage('message', result.message, 'error');
                }
            } catch (error) {
                showMessage('message', 'Terjadi kesalahan koneksi', 'error');
            } finally {
                hideLoading(btn);
            }
        });

        // Load riwayat (placeholder - bisa diperluas)
        async function loadRiwayat() {
            // Implementasi bisa diperluas untuk menampilkan riwayat penarikan khusus
            // yang dilakukan oleh pembimbing ini
            console.log('Loading riwayat...');
        }
    </script>
</body>
</html>