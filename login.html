<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
            },
            indigo: {
              600: '#4f46e5',
              500: '#6366f1',
            },
            emerald: {
              600: '#059669',
              500: '#10b981',
            }
          }
        }
      }
    }
  </script>
  <style>
    body {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    
    input {
      font-size: 16px !important;
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    input:focus {
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 1px #6366f1 !important;
    }
    
    .logo-container {
      padding: 10px;
      display: inline-block;
      border-radius: 8px;
      background: transparent;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-btn.active {
      background-color: #334155;
      border-color: #6366f1;
      color: #6366f1;
    }
  </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center p-4 text-gray-100">
  <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-md border border-slate-700">
    <!-- Header dengan Logo -->
    <div class="text-center mb-6">
      <div class="logo-container mb-4">
        <div id="logoLoading" class="w-16 h-16 flex items-center justify-center text-slate-400">
          <i class="fas fa-spinner fa-spin text-2xl"></i>
        </div>
        <img id="logoImage" alt="Logo" class="max-h-32 w-auto mx-auto hidden">
      </div>
      <h1 class="text-3xl font-extrabold text-indigo-400">Aplikasi Tabungan Santri</h1>
      <p class="text-gray-400 text-sm mt-1" id="pondokName">Pondok As-Salam Pesantren Fathul Ulum Kwagean</p>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex border-b border-slate-700 mb-6">
      <button onclick="showTab('admin')" id="tabAdmin" class="tab-btn flex-1 py-3 text-sm font-medium border-b-2 border-indigo-500 text-indigo-400 transition">
        <i class="fas fa-user-shield mr-2"></i>Login Admin
      </button>
      <button onclick="showTab('santri')" id="tabSantri" class="tab-btn flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300 transition">
        <i class="fas fa-user-graduate mr-2"></i>Santri/Wali
      </button>
    </div>

    <!-- Login Messages -->
    <div id="loginMessage" class="hidden p-3 text-sm text-red-100 bg-red-600 rounded-lg mb-4" role="alert"></div>

    <!-- Admin Login Form -->
    <form id="adminForm" class="tab-content active space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300">Email Admin</label>
        <input type="email" id="email" name="email" 
               class="mt-1 block w-full rounded-md shadow-sm p-2 border" 
               required placeholder="masukkan email admin">
      </div>
      
      <div>
        <label for="adminPassword" class="block text-sm font-medium text-gray-300">Password Admin</label>
        <input type="password" id="adminPassword" name="password" 
               class="mt-1 block w-full rounded-md shadow-sm p-2 border" 
               required placeholder="masukkan password">
      </div>
      
      <button type="submit" 
              class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
        <i class="fas fa-sign-in-alt mr-2"></i> Login Admin
      </button>
    </form>

    <!-- Santri Login Form -->
    <form id="santriForm" class="tab-content space-y-4">
      <div>
        <label for="nis" class="block text-sm font-medium text-gray-300">NIS Santri</label>
        <input type="text" id="nis" name="nis"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="masukkan NIS santri">
      </div>

      <div>
        <label for="santriPassword" class="block text-sm font-medium text-gray-300">Password Santri</label>
        <input type="password" id="santriPassword" name="password"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="masukkan password">
      </div>

      <button type="submit"
              class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out">
        <i class="fas fa-sign-in-alt mr-2"></i> Login Santri/Wali
      </button>

      <!-- Update Password Link -->
      <div class="text-center mt-4">
        <button type="button" onclick="showUpdatePasswordForm()"
                class="text-sm text-emerald-400 hover:text-emerald-300 underline">
          <i class="fas fa-key mr-1"></i> Update Password
        </button>
      </div>
    </form>

    <!-- Update Password Form -->
    <form id="updatePasswordForm" class="tab-content space-y-4" style="display: none;">
      <div>
        <label for="updateNis" class="block text-sm font-medium text-gray-300">NIS Santri</label>
        <input type="text" id="updateNis" name="nis"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="masukkan NIS santri">
      </div>

      <div>
        <label for="oldPassword" class="block text-sm font-medium text-gray-300">Password Lama</label>
        <input type="password" id="oldPassword" name="oldPassword"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="masukkan password lama">
      </div>

      <div>
        <label for="newPassword" class="block text-sm font-medium text-gray-300">Password Baru</label>
        <input type="password" id="newPassword" name="newPassword"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="masukkan password baru">
      </div>

      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-gray-300">Konfirmasi Password Baru</label>
        <input type="password" id="confirmPassword" name="confirmPassword"
               class="mt-1 block w-full rounded-md shadow-sm p-2 border"
               required placeholder="konfirmasi password baru">
      </div>

      <div class="flex space-x-2">
        <button type="submit"
                class="flex-1 flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out">
          <i class="fas fa-save mr-2"></i> Update Password
        </button>
        <button type="button" onclick="hideUpdatePasswordForm()"
                class="flex-1 flex justify-center items-center py-2 px-4 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-300 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
          <i class="fas fa-times mr-2"></i> Batal
        </button>
      </div>
    </form>

    <!-- Informasi -->
    <div class="mt-6 p-4 bg-slate-700 rounded-lg">
      <div class="flex items-start">
        <i class="fas fa-info-circle text-indigo-400 mt-1 mr-2"></i>
        <div class="text-xs text-gray-300">
          <p class="font-semibold mb-1">Informasi Login:</p>
          <ul class="list-disc list-inside space-y-1">
            <li><span class="text-indigo-300">Admin:</span> Gunakan email dan password admin</li>
            <li><span class="text-emerald-300">Santri/Wali:</span> Gunakan NIS dan password santri</li>
            <li>Untuk reset password, hubungi administrator</li>
          </ul>
        </div>
      </div>
    </div>
    
    <p class="mt-6 text-center text-xs text-gray-500">
      &copy; 2025 Pondok As-Salam Pesantren Fathul Ulum Kwagean. All rights reserved.
    </p>
  </div>
  
  <script src="./config.js"></script>
  <script src="./js/gas-shim.js"></script>
  <script>
    let currentTab = 'admin';

    // Load logo (tries backend first, falls back to local image)
    (function() {
      var logoEl = document.getElementById('logoImage');
      var loadingEl = document.getElementById('logoLoading');
      var filename = window.APP_CONFIG && window.APP_CONFIG.LOGO_FILE_NAME ? window.APP_CONFIG.LOGO_FILE_NAME : 'logo_pondok.webp';

      // First try backend getDriveImageURL
      if (window.google && window.google.script && window.google.script.run) {
        try {
          window.google.script.run.withSuccessHandler(function(url) {
            if (url) {
              logoEl.src = url;
              logoEl.classList.remove('hidden');
              loadingEl.classList.add('hidden');
            } else {
              // fallback to local
              logoEl.src = './images/' + filename;
              logoEl.classList.remove('hidden');
              loadingEl.classList.add('hidden');
            }
          }).getDriveImageURL(filename);
        } catch (e) {
          logoEl.src = './images/' + filename;
          logoEl.classList.remove('hidden');
          loadingEl.classList.add('hidden');
        }
      } else {
        logoEl.src = './images/' + filename;
        logoEl.classList.remove('hidden');
        loadingEl.classList.add('hidden');
      }
    })();

    function showTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      
      const activeBtn = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
      activeBtn.classList.add('border-indigo-500', 'text-indigo-400');
      activeBtn.classList.remove('border-transparent', 'text-gray-400');
      
      // Update forms
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tab + 'Form') && document.getElementById(tab + 'Form').classList.add('active');
      
      // Clear messages
      document.getElementById('loginMessage').classList.add('hidden');
    }

    // Admin form submission
    document.getElementById('adminForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('adminPassword').value;
      const messageEl = document.getElementById('loginMessage');
      const submitBtn = this.querySelector('button[type="submit"]');

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
      messageEl.classList.add('hidden');

      google.script.run.withSuccessHandler(function(response) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login Admin';
        
        if (response.success) {
          if (response.admin) {
            // Simpan dengan validasi data
            const adminData = response.admin;
            if (adminData.nama) {
              sessionStorage.setItem('adminNama', adminData.nama.toString().trim());
            }
            if (adminData.otoritas) {
              sessionStorage.setItem('adminOtoritas', adminData.otoritas.toString().trim());
            }
            if (adminData.email) {
              sessionStorage.setItem('adminEmail', adminData.email.toString().trim());
            }
            
            // Debug: log session storage setelah simpan
            console.log('Session storage after login:', {
              nama: sessionStorage.getItem('adminNama'),
              otoritas: sessionStorage.getItem('adminOtoritas'),
              email: sessionStorage.getItem('adminEmail')
            });
          }
          window.location.href = response.redirectUrl;
        } else {
          messageEl.textContent = response.message;
          messageEl.classList.remove('hidden');
          messageEl.classList.add('bg-red-600');
        }
      }).withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login Admin';
        messageEl.textContent = 'Terjadi kesalahan: ' + error.message;
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-600');
      }).verifyAdminLogin(email, password);
    });

    // Santri form submission
    document.getElementById('santriForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const nis = document.getElementById('nis').value;
      const password = document.getElementById('santriPassword').value;
      const messageEl = document.getElementById('loginMessage');
      const submitBtn = this.querySelector('button[type="submit"]');

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
      messageEl.classList.add('hidden');

      google.script.run.withSuccessHandler(function(response) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login Santri/Wali';

        if (response.success) {
          if (response.santri) {
            sessionStorage.setItem('santriNis', response.santri.nis);
            sessionStorage.setItem('santriNama', response.santri.nama);
            sessionStorage.setItem('santriLimit', response.santri.limitHarian);
          }
          window.location.href = response.redirectUrl;
        } else {
          messageEl.textContent = response.message;
          messageEl.classList.remove('hidden');
          messageEl.classList.add('bg-red-600');
        }
      }).withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login Santri/Wali';
        messageEl.textContent = 'Terjadi kesalahan: ' + error.message;
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-600');
      }).verifySantriLogin(nis, password);
    });

    // Update password form functions
    function showUpdatePasswordForm() {
      document.getElementById('santriForm').style.display = 'none';
      document.getElementById('updatePasswordForm').style.display = 'block';
      document.getElementById('loginMessage').classList.add('hidden');
    }

    function hideUpdatePasswordForm() {
      document.getElementById('updatePasswordForm').style.display = 'none';
      document.getElementById('santriForm').style.display = 'block';
      document.getElementById('loginMessage').classList.add('hidden');
      // Clear form
      document.getElementById('updatePasswordForm').reset();
    }

    // Update password form submission
    document.getElementById('updatePasswordForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const nis = document.getElementById('updateNis').value;
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageEl = document.getElementById('loginMessage');
      const submitBtn = this.querySelector('button[type="submit"]');

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        messageEl.textContent = 'Password baru dan konfirmasi tidak cocok';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-600');
        return;
      }

      // Validate password length
      if (newPassword.length < 6) {
        messageEl.textContent = 'Password baru minimal 6 karakter';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-600');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
      messageEl.classList.add('hidden');

      google.script.run.withSuccessHandler(function(response) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Update Password';

        if (response.success) {
          messageEl.textContent = 'Password berhasil diupdate';
          messageEl.classList.remove('hidden');
          messageEl.classList.remove('bg-red-600');
          messageEl.classList.add('bg-green-600');
          // Clear form after success
          document.getElementById('updatePasswordForm').reset();
          // Auto hide form after 3 seconds
          setTimeout(function() {
            hideUpdatePasswordForm();
          }, 3000);
        } else {
          messageEl.textContent = response.message;
          messageEl.classList.remove('hidden');
          messageEl.classList.add('bg-red-600');
        }
      }).withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Update Password';
        messageEl.textContent = 'Terjadi kesalahan: ' + error.message;
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-600');
      }).updatePasswordSantri(nis, oldPassword, newPassword);
    });

    // Initialize admin tab as active
    window.onload = function() {
      showTab('admin');
    };
  </script>
</body>
</html>
