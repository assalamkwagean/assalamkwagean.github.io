<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script>
    // Konfigurasi Tailwind untuk palet warna Dark Mode
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
            },
            indigo: {
              600: '#4f46e5',
              500: '#6366f1',
            }
          }
        }
      }
    }
  </script>
  <style>
    /* =============================================
       MOBILE ZOOM PREVENTION - ENHANCED
       ============================================= */
    
    /* Base font size untuk mobile - CRITICAL untuk prevent zoom */
    body {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* Minimum 16px font-size untuk SEMUA input elements */
    input, 
    textarea, 
    select:not(.select2) {
      font-size: 16px !important;
      transform: scale(1);
      max-height: 44px !important; /* Minimum touch target size */
      min-height: 44px !important;
      -webkit-appearance: none;
      appearance: none;
      border-radius: 6px !important;
    }

    /* Untuk elemen input kecil di tabel */
    .tagihan-table input {
      font-size: 16px !important;
      max-height: 38px !important;
      min-height: 38px !important;
    }

    /* Select2 elements - Enhanced untuk mobile */
    .select2-container--default .select2-selection--single,
    .select2-container--default .select2-selection--multiple {
      font-size: 16px !important;
      min-height: 44px !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
    }

    .select2-container--default .select2-selection--single {
      height: 44px !important;
      display: flex !important;
      align-items: center !important;
    }

    .select2-container--default .select2-selection--multiple {
      min-height: 44px !important;
      padding-top: 4px !important;
      padding-bottom: 4px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 44px !important;
      font-size: 16px !important;
      color: #f1f5f9 !important;
    }

    .select2-container--default .select2-search--inline .select2-search__field {
      font-size: 16px !important;
      color: #f1f5f9 !important;
      background: transparent !important;
      margin-top: 8px !important;
      height: 32px !important;
    }

    /* Tombol juga perlu ukuran touch yang cukup */
    button {
      min-height: 44px;
      touch-action: manipulation;
    }

    /* iOS Specific fixes */
    @supports (-webkit-touch-callout: none) {
      input, 
      textarea, 
      select:not(.select2) {
        font-size: 16px !important;
        transform: scale(1);
      }
      
      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple {
        font-size: 16px !important;
      }
    }

    /* Untuk desktop - kembalikan ke ukuran normal */
    @media (min-width: 768px) {
      input, 
      textarea, 
      select:not(.select2) {
        font-size: 14px !important;
        max-height: none !important;
        min-height: auto !important;
      }
      
      .tagihan-table input {
        font-size: 13px !important;
        max-height: none !important;
        min-height: auto !important;
      }
      
      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple {
        font-size: 14px !important;
        min-height: auto !important;
      }
      
      .select2-container--default .select2-selection--single {
        height: auto !important;
      }
      
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: normal !important;
        font-size: 14px !important;
      }
    }

    /* Additional prevention techniques */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
    }

    /* =============================================
       SELECT2 DARK MODE STYLING
       ============================================= */
    .select2-container--default .select2-results__option[aria-selected="true"] {
      background-color: #4f46e5 !important;
      color: white !important;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #4f46e5;
      border: none;
      color: white;
      padding: 4px 8px;
      font-size: 14px !important;
    }
    
    .select2-dropdown {
      background-color: #334155 !important;
      border-color: #475569 !important;
    }
    
    .select2-container--default .select2-results__option {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #4f46e5 !important;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
      background-color: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
      font-size: 16px !important;
      min-height: 38px !important;
    }

    /* =============================================
       RECEIPT STYLING - UPDATED dengan perbaikan
       ============================================= */
    #receiptContent {
      width: 80mm !important;
      min-height: 50mm;
      background: white;
      color: #000 !important;
      padding: 5mm;
      box-sizing: border-box;
      position: relative;
      overflow: visible !important;
    }

    /* Pastikan gambar logo ter-load dengan baik */
    #receiptContent img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    /* Prevent content dari terpotong */
    #receiptContent * {
      box-sizing: border-box;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* Untuk perangkat dengan DPI tinggi */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      #receiptContent {
        transform: translateZ(0);
        -webkit-font-smoothing: antialiased;
      }
    }

    #totalTagihan, #totalPotongan, #totalDibayar {
      background-color: #1e293b !important;
      border-color: #475569 !important;
      cursor: not-allowed;
    }

    @media print {
      #receiptContent {
        width: 80mm !important;
        min-height: unset;
        position: relative !important;
        box-shadow: none !important;
        padding-bottom: 10mm;
        overflow: visible !important;
      }
      
      @page {
        size: 80mm auto;
        margin: 0 !important;
      }
    
      #receiptModal {
        position: static !important;
        background: transparent !important;
      }
      
      #receiptModal > div {
        max-height: 90vh;
        overflow-y: auto;
      }

      body * {
        visibility: hidden;
      }

      #receiptContent, #receiptContent * {
        visibility: visible;
      }

      #receiptContent img {
        max-width: 100% !important;
        height: auto !important;
        page-break-inside: avoid;
      }

      .select2-dropdown, 
      .select2-search__field,
      .select2-results__option {
        display: none !important;
      }
      .select2-selection__rendered {
        visibility: visible !important;
      }
      #totalTagihan, #totalPotongan, #totalDibayar {
        border: none !important;
        font-weight: 600;
        color: #1e40af;
        pointer-events: none;
      }

      .receipt-container .text-blue-600 {
        color: #1e40af;
        font-size: 15px;
      }
    }
    
    /* =============================================
       DARK MODE FORM STYLING
       ============================================= */
    input, textarea, select:not(.select2) {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    input:focus, textarea:focus, select:focus:not(.select2) {
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 1px #6366f1 !important;
      outline: none !important;
    }
    
    input[readonly], select[disabled] {
      background-color: #475569 !important;
      color: #94a3b8 !important;
    }
    
    .tagihan-table th {
      background-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    .tagihan-table td {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    .tagihan-table tfoot td {
      background-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    .tagihan-table input {
      background-color: #1e293b !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    .tagihan-table input[readonly] {
      background-color: #475569 !important;
      color: #94a3b8 !important;
    }

    /* =============================================
       COMPONENT SPECIFIC STYLING
       ============================================= */
    
    /* Info box styling */
    .info-box {
      background-color: #1e40af;
      border-left: 4px solid #3b82f6;
      padding: 8px 12px;
      margin-top: 4px;
      border-radius: 4px;
      font-size: 11px;
    }

    .info-box.success {
      background-color: #065f46;
      border-left-color: #10b981;
    }

    /* Animation for notifications */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Loading states */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive table container */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Mobile specific adjustments */
    @media (max-width: 767px) {
      .mobile-stack {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
      }
      
      .container {
        padding-left: 12px;
        padding-right: 12px;
      }
      
      .bg-slate-800.rounded-lg {
        border-radius: 12px;
        margin: 8px;
      }
      
      /* Improve touch targets for mobile */
      .flex > button, 
      .flex > a {
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* High DPI screen optimizations */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .tagihan-table input,
      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple {
        border-width: 1.5px !important;
      }
    }

    /* Reduced motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus indicators for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid #6366f1;
      outline-offset: 2px;
    }

    /* Print optimizations */
    @media print {
      .no-print {
        display: none !important;
      }
      
      .bg-slate-800,
      .bg-slate-900 {
        background: white !important;
        color: black !important;
      }
    }

    /* Scrollbar styling for webkit browsers */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #4f46e5;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6366f1;
    }
  /* =============================================
   SIMPLE TOGGLE BUTTON STYLING - BIAYA ADMINISTRATIF
   ============================================= */

  /* Toggle button container */
  .toggle-button {
    display: inline-flex;
    align-items: center;
    padding: 10px 16px;
    border: 2px solid #475569;
    border-radius: 8px;
    background-color: #334155;
    color: #f1f5f9;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }

  /* Hover state */
  .toggle-button:hover {
    border-color: #6366f1;
    transform: translateY(-1px);
  }

  /* Active state (ON) */
  .toggle-button.active {
    background-color: #10b981;
    border-color: #10b981;
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  /* Focus state */
  .toggle-button:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
  }

  /* Icon styling */
  .toggle-button i {
    margin-right: 8px;
    font-size: 14px;
  }

  /* Container styling */
  .biaya-admin-toggle {
    background-color: #334155;
    border: 1px solid #475569;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  /* Section animation */
  #biayaAdminSection {
    transition: all 0.3s ease;
  }

  #biayaAdminSection.hidden {
    display: none;
  }

  #biayaAdminSection:not(.hidden) {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Mobile optimization */
  @media (max-width: 767px) {
    .toggle-button {
      padding: 12px 18px;
      font-size: 16px;
    }
    
    .biaya-admin-toggle {
      padding: 12px;
    }
  }
  </style>
</head>
<body class="bg-slate-900 min-h-screen text-gray-100">
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <div class="bg-slate-800 rounded-lg shadow-lg p-6 border border-slate-700">
      <div class="flex flex-col items-center mb-6">
        <img id="logoImage" alt="Logo <?= CONFIG.PONDOK_NAME ?>" class="h-16 mb-3">
        <h1 class="text-2xl font-bold text-indigo-400 text-center">Pembayaran <?= CONFIG.PONDOK_NAME ?></h1>
        <p class="text-gray-400 mt-1"><?= CONFIG.PESANTREN_NAME ?> Periode <?= CONFIG.ACADEMIC_YEAR ?></p>
      </div>
      <form id="paymentForm" class="space-y-4">
        <div>
          <label for="nis" class="block text-sm font-medium text-gray-300">NIS/Nama Santri</label>
          <select id="nis" name="nis" class="mt-1 block w-full select2" required>
            <option value="">Pilih Santri</option>
          </select>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="nama" class="block text-sm font-medium text-gray-300">Nama Santri</label>
            <input type="text" id="nama" name="nama" class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" readonly>
          </div>
          <div>
            <label for="kategori" class="block text-sm font-medium text-gray-300">Kategori</label>
            <input type="text" id="kategori" name="kategori" class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" readonly>
          </div>
        </div>
        
        <div>
          <label for="jenisTagihan" class="block text-sm font-medium text-gray-300">
            Jenis Tagihan (Pilih Banyak)
            <span class="text-xs text-gray-400 ml-2">* Hanya menampilkan tagihan yang belum lunas</span>
          </label>
          <select id="jenisTagihan" name="jenisTagihan" class="mt-1 block w-full" multiple="multiple" required></select>
          <div id="tagihanInfo" class="hidden info-box mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            <span id="tagihanInfoText"></span>
          </div>
        </div>

        <!-- Bill Details Table -->
        <div id="tagihanSection" class="hidden">
          <div class="overflow-x-auto">
            <table class="w-full tagihan-table">
              <thead class="bg-slate-700">
                <tr>
                  <th class="text-left py-2 px-4">Jenis Tagihan</th>
                  <th class="text-left py-2 px-4">Sisa Tagihan</th>
                  <th class="text-left py-2 px-4">Potongan</th>
                  <th class="text-left py-2 px-4">Jumlah Dibayar</th>
                </tr>
              </thead>
            </table>
            <div style="max-height: 300px; overflow-y: auto;">
              <table class="w-full tagihan-table">
                <tbody id="tagihanList"></tbody>
              </table>
            </div>
            <table class="w-full tagihan-table">
              <tfoot>
                <tr class="bg-slate-700 font-bold">
                  <td class="py-2 px-4">TOTAL</td>
                  <td class="py-2 px-4">
                    <span id="totalTagihan" class="text-indigo-400 font-semibold"></span>
                  </td>
                  <td class="py-2 px-4">
                    <span id="totalPotongan" class="text-indigo-400 font-semibold"></span>
                  </td>
                  <td class="py-2 px-4">
                    <span id="totalDibayar" class="text-indigo-400 font-semibold"></span>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="grid grid-cols-2 gap-4 mobile-stack">
          <div>
            <label for="metode" class="block text-sm font-medium text-gray-300">Metode Pembayaran</label>
            <select id="metode" name="metode" class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" required>
              <option value="">Pilih Metode</option>
            </select>
          </div>
          <div>
            <label for="penerima" class="block text-sm font-medium text-gray-300">Penerima</label>
            <!-- PERUBAHAN: Ubah dari select menjadi input text yang readonly -->
            <input type="text" id="penerima" name="penerima" 
                   class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-slate-700 text-gray-300" 
                   readonly 
                   required
                   placeholder="Akan terisi otomatis sesuai admin yang login">
          </div>
        </div>

        <!-- SECTION BARU: Biaya Administratif -->
        <div class="bg-slate-700 p-4 rounded-lg border border-slate-600">
          <div class="biaya-admin-toggle">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <i class="fas fa-file-invoice mr-2 text-indigo-400"></i>
                <span class="text-sm font-medium text-gray-300">Biaya Administratif (Opsional)</span>
              </div>
              
              <button type="button" id="enableBiayaAdmin" class="toggle-button">
                <i class="fas fa-plus"></i>
                <span>Aktifkan</span>
              </button>
            </div>
          </div>
          
          <div id="biayaAdminSection" class="hidden space-y-3">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="biayaAdminPreset" class="block text-xs font-medium text-gray-400 mb-1">Pilih Preset (Opsional)</label>
                <select id="biayaAdminPreset" class="block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-sm">
                  <option value="">-- Pilih atau isi manual --</option>
                </select>
              </div>
              <div>
                <label for="biayaAdminJumlah" class="block text-xs font-medium text-gray-400 mb-1">Jumlah</label>
                <input type="number" id="biayaAdminJumlah" min="0" value="0" 
                       class="block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-sm"
                       placeholder="0">
              </div>
            </div>
            <div>
              <label for="biayaAdminKeterangan" class="block text-xs font-medium text-gray-400 mb-1">Keterangan</label>
              <input type="text" id="biayaAdminKeterangan" 
                     class="block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-sm"
                     placeholder="Contoh: Biaya Admin Transfer Bank">
            </div>
            <div class="text-xs text-gray-400 bg-slate-800 p-2 rounded">
              <i class="fas fa-info-circle mr-1"></i>
              Biaya ini akan muncul sebagai item terpisah di kwitansi
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Catatan</label>
          <textarea id="catatan" name="catatan" rows="2" 
                    class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
          
          <div class="flex flex-wrap gap-2 mb-2">
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('Potongan')">Potongan</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('Syahriah')">Syahriah</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('Kos Makan')">Kos Makan</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('SPP Tahfidz')">SPP Tahfidz</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('SPP Formal')">SPP Formal</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('Laundry')">Laundry</span>
            <span class="cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm" 
                  onclick="addNote('Transport')">Transport</span>
          </div>
        </div>

        <div class="flex justify-end space-x-3 pt-4">
          <button type="reset" class="px-4 py-2 bg-slate-700 text-gray-100 rounded-md hover:bg-slate-600 transition duration-150">Reset</button>
          <button type="submit" id="submitBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 flex items-center justify-center transition duration-150">
            <i class="fas fa-save mr-2"></i> Simpan Pembayaran
          </button>
        </div>

        <div class="mt-6 pt-4 border-t border-slate-700">
          <a href="<?= ScriptApp.getService().getUrl() ?>?page=recap" 
            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 flex items-center justify-center transition duration-150">
            <i class="fas fa-chart-bar mr-2"></i> Lihat Rekapitulasi
          </a>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Modal Receipt -->
  <div id="receiptModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden print:block print:bg-transparent">
    <div class="bg-white rounded-lg p-6 max-w-md w-full print:shadow-none print:max-w-full">
      <div id="receiptContent"></div>
      <div class="mt-4 flex justify-end print:hidden">
        <button id="closeReceipt" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
          <i class="fas fa-times mr-1"></i> Tutup
        </button>      
      </div>
    </div>
  </div>

  <script>
    let APP_CONFIG = {
      pondokName: '<?= CONFIG.PONDOK_NAME ?>',
      pesantrenName: '<?= CONFIG.PESANTREN_NAME ?>',
      academicYear: '<?= CONFIG.ACADEMIC_YEAR ?>'
    };

    let currentReceiptData = null;
    let kwitansiLogoDataUrl = null;
    let isLoadingBills = false; // Flag to prevent race conditions

    // PERBAIKAN: Fungsi untuk mengisi ulang field penerima
    function refreshPenerimaField() {
      const adminNama = sessionStorage.getItem('adminNama');
      if (adminNama) {
        $('#penerima').val(adminNama);
      } else {
        console.warn('Nama admin tidak ditemukan di sessionStorage');
        $('#penerima').val('Admin Tidak Diketahui');
      }
    }

    $(document).ready(function() {
      // PERBAIKAN: Panggil fungsi refreshPenerimaField saat halaman dimuat
      refreshPenerimaField();
      
      // Initialize Select2 dengan konfigurasi yang benar
      $('#nis').select2({
        placeholder: "Pilih Santri",
        allowClear: true,
        width: '100%',
        dropdownParent: $('body') // Pastikan dropdown tidak terpotong
      });
      
      // Initialize Select2 untuk jenisTagihan
      $('#jenisTagihan').select2({
        placeholder: "Pilih Jenis Tagihan",
        multiple: true,
        allowClear: true,
        width: '100%'
      });

      /**
       * FUNGSI BARU: Load Bill Types dengan Sisa Tagihan
       * Memuat tagihan yang sudah dikurangi dengan pembayaran di RECAP
       * Hanya menampilkan tagihan dengan sisa > 0
       */
      function loadBillTypes(categoryName, nis) {
        $('#jenisTagihan').empty(); // Kosongkan dulu dropdown
        $('#tagihanInfo').addClass('hidden');
        
        // Tambahkan loading state
        $('#jenisTagihan').append(new Option('Memuat tagihan...', '', true, true));
        $('#jenisTagihan').prop('disabled', true);
        
        google.script.run.withSuccessHandler(function(tagihanList) {
          $('#jenisTagihan').empty(); // Kosongkan loading
          $('#jenisTagihan').prop('disabled', false);
          
          if (tagihanList && tagihanList.length > 0) {
            // Tambahkan opsi tagihan dengan info sisa
            tagihanList.forEach(tagihan => {
              const optionText = `${tagihan.nama} (Sisa: Rp ${tagihan.jumlah.toLocaleString('id-ID')})`;
              const option = new Option(optionText, tagihan.nama);
              // Simpan data lengkap di data attribute
              $(option).data('tagihan', tagihan);
              $('#jenisTagihan').append(option);
            });
            
            // Tampilkan info
            $('#tagihanInfo').removeClass('hidden').addClass('success');
            $('#tagihanInfoText').text(`Ditemukan ${tagihanList.length} tagihan yang belum lunas`);
            
            // Re-initialize Select2
            $('#jenisTagihan').select2('destroy');
            $('#jenisTagihan').select2({
              placeholder: "Pilih Jenis Tagihan",
              multiple: true,
              allowClear: true,
              width: '100%'
            });
          } else {
            // Jika tidak ada tagihan
            $('#jenisTagihan').append(new Option('Tidak ada tagihan tersisa', '', true, true));
            $('#jenisTagihan').prop('disabled', true);
            
            $('#tagihanInfo').removeClass('hidden').removeClass('success');
            $('#tagihanInfoText').html('<i class="fas fa-check-circle mr-1"></i> Semua tagihan untuk kategori ini sudah lunas!');
            
            alert('ðŸŽ‰ Alhamdulillah! Semua tagihan untuk kategori ini sudah lunas!');
          }
        }).withFailureHandler(error => {
          console.error('Gagal memuat tagihan:', error);
          $('#jenisTagihan').empty();
          $('#jenisTagihan').append(new Option('Gagal memuat tagihan', '', true, true));
          $('#jenisTagihan').prop('disabled', true);
          
          $('#tagihanInfo').removeClass('hidden').removeClass('success');
          $('#tagihanInfoText').html('<i class="fas fa-exclamation-triangle mr-1"></i> Gagal memuat data tagihan. Silakan coba lagi.');
          
          alert('Gagal memuat data tagihan. Silakan coba lagi.');
        }).getCategoriesWithBalance(categoryName, nis);
      }

      // Load logo
      google.script.run.withSuccessHandler(function(url) {
        if (url) {
          document.getElementById('logoImage').src = url;
          document.getElementById('logoImage').classList.remove('hidden');
        } else {
          console.error('Gagal memuat logo');
        }
      }).getDriveImageURL('<?= CONFIG.LOGO_FILE_NAME ?>');

      // Load initial data
      google.script.run.withSuccessHandler(function(students) {
        students.forEach(student => $('#nis').append(new Option(`${student[1]} (${student[0]})`, student[0])));
      }).getActiveStudents();

      google.script.run.withSuccessHandler(function(methods) {
        methods.forEach(method => $('#metode').append(new Option(method, method)));
      }).getPaymentMethods();

      // BARU: Load admin fee options
      google.script.run.withSuccessHandler(function(options) {
        options.forEach(opt => {
          $('#biayaAdminPreset').append(new Option(`${opt.nama} - Rp ${opt.jumlah.toLocaleString('id-ID')}`, JSON.stringify(opt)));
        });
      }).getAdminFeeOptions();

      // Handle toggle biaya admin
      $('#enableBiayaAdmin').click(function() {
        const $button = $(this);
        const isActive = $button.hasClass('active');
        
        if (isActive) {
          // Nonaktifkan
          $button.removeClass('active');
          $button.html('<i class="fas fa-plus"></i><span>Aktifkan</span>');
          $('#biayaAdminSection').addClass('hidden');
          $('#biayaAdminJumlah').val(0);
          $('#biayaAdminKeterangan').val('');
          $('#biayaAdminPreset').val('');
        } else {
          // Aktifkan
          $button.addClass('active');
          $button.html('<i class="fas fa-check"></i><span>Aktif</span>');
          $('#biayaAdminSection').removeClass('hidden');
        }
        
        updateGrandTotal();
      });

      // BARU: Handle metode pembayaran change - auto suggest admin fee
      $('#metode').change(function() {
        const metode = $(this).val();
        if (!metode) return;

        // Auto-suggest admin fee based on payment method
        google.script.run.withSuccessHandler(function(fee) {
          if (fee > 0 && !$('#enableBiayaAdmin').is(':checked')) {
            // Auto-enable dan isi jika ada biaya admin
            $('#enableBiayaAdmin').prop('checked', true).trigger('change');
            $('#biayaAdminJumlah').val(fee);
            $('#biayaAdminKeterangan').val(`Biaya Admin ${metode}`);
            updateGrandTotal();
            
            // Show notification
            showNotification(`Biaya admin Rp ${fee.toLocaleString('id-ID')} ditambahkan otomatis untuk ${metode}`);
          }
        }).getAdminFee(metode);
      });

      // BARU: Handle preset selection
      $('#biayaAdminPreset').change(function() {
        const selectedValue = $(this).val();
        if (selectedValue) {
          try {
            const data = JSON.parse(selectedValue);
            $('#biayaAdminJumlah').val(data.jumlah);
            $('#biayaAdminKeterangan').val(data.nama);
            updateGrandTotal();
          } catch (e) {
            console.error('Error parsing preset:', e);
          }
        }
      });

      // BARU: Handle manual input change
      $('#biayaAdminJumlah').on('input', function() {
        updateGrandTotal();
      });

      // Handle student selection - MODIFIED
      $('#nis').change(function() {
        const nis = $(this).val();
        $('#jenisTagihan').val(null).trigger('change'); // Reset bill selection
        $('#tagihanList').empty();
        $('#tagihanSection').addClass('hidden');
        $('#tagihanInfo').addClass('hidden');
        
        if (!nis) {
          $('#nama').val('');
          $('#kategori').val('');
          $('#jenisTagihan').empty().append(new Option('Pilih Santri terlebih dahulu', ''));
          $('#jenisTagihan').prop('disabled', true);
          return;
        }
        
        const selectedData = $('#nis').select2('data')[0];
        const studentName = selectedData ? selectedData.text.split(' (')[0] : '';
        $('#nama').val(studentName);
        
        google.script.run.withSuccessHandler(function(students) {
          const student = students.find(s => s[0] == nis);
          if (student) {
            const categoryName = student[2];
            $('#kategori').val(categoryName);
            // Pass both category and NIS - PERUBAHAN UTAMA
            loadBillTypes(categoryName, nis);
          }
        }).getActiveStudents();
      });

      // Handle bill type selection - MODIFIED
      $('#jenisTagihan').change(function() {
        if (isLoadingBills) {
            return; // Prevent function from running if it's already loading
        }

        const selectedBills = $(this).val();
        $('#tagihanList').empty(); // Clear previous bills immediately
        
        if (!selectedBills || selectedBills.length === 0) {
          $('#tagihanSection').addClass('hidden');
          calculateTotals(); // Recalculate to zero out totals
          return;
        }
        
        // --- START: Loading State ---
        isLoadingBills = true;
        $('#jenisTagihan').prop('disabled', true);
        $('#tagihanSection').removeClass('hidden');
        $('#tagihanList').html('<tr><td colspan="4" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i> Memuat rincian tagihan...</td></tr>');
        
        const onComplete = () => {
            isLoadingBills = false;
            $('#jenisTagihan').prop('disabled', false);
        };
        // --- END: Loading State ---

        // Ambil data dari option yang sudah dimuat sebelumnya - PERUBAHAN UTAMA
        $('#tagihanList').empty(); // Clear loading indicator
        
        selectedBills.forEach(billName => {
          // Cari data tagihan dari option select2
          const option = $('#jenisTagihan option').filter(function() {
            return $(this).val() === billName;
          });
          
          const tagihanData = option.data('tagihan');
          
          if (tagihanData) {
            // Tampilkan info jika ada pembayaran sebelumnya
            const infoText = tagihanData.sudahDibayar > 0 
              ? `<small class="text-gray-400">ðŸ“Š Total: Rp ${tagihanData.jumlahAsli.toLocaleString('id-ID')} | Sudah Dibayar: Rp ${tagihanData.sudahDibayar.toLocaleString('id-ID')}</small>`
              : `<small class="text-gray-400">ðŸ“Š Total Tagihan Awal: Rp ${tagihanData.jumlahAsli.toLocaleString('id-ID')}</small>`;
            
            $('#tagihanList').append(`
              <tr class="border-b">
                <td class="py-2 px-4">
                  <div class="font-medium">${billName}</div>
                  <div class="mt-1">${infoText}</div>
                </td>
                <td class="py-2 px-4">
                  <input type="number" class="w-full jumlah-tagihan bg-gray-100 font-semibold" value="${tagihanData.jumlah}" readonly>
                </td>
                <td class="py-2 px-4">
                  <input type="number" class="w-full potongan" value="0" min="0" max="${tagihanData.jumlah}">
                </td>
                <td class="py-2 px-4">
                  <input type="number" class="w-full jumlah-dibayar bg-gray-100 font-semibold" value="${tagihanData.jumlah}" readonly>
                </td>
              </tr>
            `);
          }
        });
        
        calculateTotals();
        onComplete();
      });

      // Auto calculate payment when 'potongan' changes
      $(document).on('input', '.potongan', function() {
        const row = $(this).closest('tr');
        const tagihan = parseFloat(row.find('.jumlah-tagihan').val()) || 0;
        let potongan = parseFloat($(this).val()) || 0;

        // Ensure potongan is not more than the bill amount
        if (potongan > tagihan) {
          potongan = tagihan;
          $(this).val(potongan);
        }
        
        row.find('.jumlah-dibayar').val(tagihan - potongan);
        calculateTotals();
      });

      // Handle form submission
      $('#paymentForm').submit(function(e) {
        e.preventDefault();
        const tagihanData = [];
        
        $('#tagihanList tr').each(function() {
          const row = $(this);
          tagihanData.push({
            jenisTagihan: row.find('td:eq(0) .font-medium').text(),
            jumlahTagihan: row.find('.jumlah-tagihan').val(),
            potongan: row.find('.potongan').val() || 0,
            jumlahDibayar: row.find('.jumlah-dibayar').val()
          });
        });

        if (tagihanData.length === 0) {
          alert('Pilih minimal satu jenis tagihan!');
          return;
        }

        const formData = {
          nis: $('#nis').val(),
          nama: $('#nama').val(),
          kategori: $('#kategori').val(),
          metode: $('#metode').val(),
          penerima: $('#penerima').val(), // Tetap ambil nilai dari field penerima
          catatan: $('#catatan').val(),
          tagihan: tagihanData
        };

        // BARU: Tambahkan biaya admin jika diaktifkan
        if ($('#enableBiayaAdmin').is(':checked')) {
          const biayaAdminJumlah = parseFloat($('#biayaAdminJumlah').val()) || 0;
          const biayaAdminKeterangan = $('#biayaAdminKeterangan').val() || 'Biaya Administratif';
          
          if (biayaAdminJumlah > 0) {
            formData.biayaAdmin = {
              jumlah: biayaAdminJumlah,
              keterangan: biayaAdminKeterangan
            };
          }
        }

        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...');

        google.script.run.withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .processPayment(formData);
      });
      
      // Reset form handler
      $('#paymentForm').on('reset', function() {
          $('#nis, #jenisTagihan').val(null).trigger('change');
          $('#tagihanList').empty();
          $('#tagihanSection').addClass('hidden');
          $('#tagihanInfo').addClass('hidden');
          $('#enableBiayaAdmin').prop('checked', false).trigger('change');
          $('#biayaAdminJumlah').val(0);
          $('#biayaAdminKeterangan').val('');
          $('#biayaAdminPreset').val('');
          $('#grandTotalRow').remove();
          calculateTotals();
          
          // PERBAIKAN: Setelah reset, refresh field penerima
          setTimeout(refreshPenerimaField, 100);
      });

      // Modal handlers
      $('#closeReceipt').click(() => $('#receiptModal').addClass('hidden'));
      
      // PDF Download handler
	  $('#downloadPDF').click(function() {
	    if (!currentReceiptData) return;
	  
	    const downloadBtn = $(this);
	    const originalText = downloadBtn.html();
	  
	    // Disable button dan tampilkan loading
	    downloadBtn.prop('disabled', true);
	    downloadBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i> Memproses...');
	  
	    const element = document.getElementById('receiptContent');
	    const filename = `Kwitansi_${currentReceiptData.nama.replace(/\s+/g, '_')}_${currentReceiptData.nis}_${Date.now()}.pdf`;
	  
	    // Tunggu hingga semua gambar ter-load
	    const images = element.getElementsByTagName('img');
	    const imageLoadPromises = Array.from(images).map(img => {
		  if (img.complete) return Promise.resolve();
		  return new Promise(resolve => {
		    img.onload = resolve;
		    img.onerror = resolve;
		  });
	    });
	  
	    Promise.all(imageLoadPromises).then(() => {
		  // Hitung tinggi konten yang sebenarnya
		  const contentHeight = element.scrollHeight;
		  const pdfHeight = Math.max(contentHeight * 0.2645, 100);
		
		  const options = {
		    margin: [2, 0, 2, 0],
		    filename: filename,
		    image: { 
			  type: 'jpeg', 
			  quality: 0.98 
		    },
		    html2canvas: {
			  scale: 3,
			  logging: false,
			  useCORS: true,
			  letterRendering: true,
			  allowTaint: true,
			  scrollY: 0,
			  scrollX: 0,
			  windowHeight: contentHeight + 100
		    },
		    jsPDF: {
			  unit: 'mm',
			  format: [80, pdfHeight],
			  orientation: 'portrait',
			  compress: true
		    },
		    pagebreak: { 
			  mode: ['avoid-all', 'css', 'legacy']
		    }
		  };
		
		  html2pdf()
		    .set(options)
		    .from(element)
		    .save()
		    .then(() => {
			  // Reset button setelah berhasil
			  downloadBtn.prop('disabled', false);
			  downloadBtn.html(originalText);
		    })
		    .catch(err => {
			  console.error('Error generating PDF:', err);
			  alert('Terjadi kesalahan saat membuat PDF: ' + err.message);
			  downloadBtn.prop('disabled', false);
			  downloadBtn.html(originalText);
		    });
	    }).catch(err => {
		  console.error('Error loading images:', err);
		  downloadBtn.prop('disabled', false);
		  downloadBtn.html(originalText);
	    });
	  });
      loadKwitansiLogo();
    });

    function calculateTotals() {
      let totalTagihan = 0;
      let totalPotongan = 0;
      let totalDibayar = 0;

      $('#tagihanList tr').each(function() {
        const $row = $(this);
        totalTagihan += parseFloat($row.find('.jumlah-tagihan').val()) || 0;
        totalPotongan += parseFloat($row.find('.potongan').val()) || 0;
        totalDibayar += parseFloat($row.find('.jumlah-dibayar').val()) || 0;
      });

      $('#totalTagihan').text('Rp ' + totalTagihan.toLocaleString('id-ID'));
      $('#totalPotongan').text('Rp ' + totalPotongan.toLocaleString('id-ID'));
      $('#totalDibayar').text('Rp ' + totalDibayar.toLocaleString('id-ID'));
      
      updateGrandTotal();
    }

    // FUNGSI BARU: Update grand total (tagihan + biaya admin)
    function updateGrandTotal() {
      let totalDibayar = 0;
      $('#tagihanList tr').each(function() {
        totalDibayar += parseFloat($(this).find('.jumlah-dibayar').val()) || 0;
      });

      const biayaAdmin = $('#enableBiayaAdmin').is(':checked') 
        ? (parseFloat($('#biayaAdminJumlah').val()) || 0) 
        : 0;

      const grandTotal = totalDibayar + biayaAdmin;

      // Update atau buat baris grand total jika belum ada
      if ($('#grandTotalRow').length === 0 && biayaAdmin > 0) {
        $('table.tagihan-table tfoot').append(`
          <tr id="grandTotalRow" class="bg-indigo-900 font-bold">
            <td colspan="3" class="py-2 px-4">TOTAL + BIAYA ADMIN</td>
            <td class="py-2 px-4">
              <span id="grandTotal" class="text-green-400 font-semibold"></span>
            </td>
          </tr>
        `);
      }

      if (biayaAdmin > 0) {
        $('#grandTotal').text('Rp ' + grandTotal.toLocaleString('id-ID'));
        $('#grandTotalRow').show();
      } else {
        $('#grandTotalRow').hide();
      }
    }

    // FUNGSI BARU: Show notification
    function showNotification(message) {
      const notification = $(`
        <div class="fixed top-4 right-4 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in">
          <i class="fas fa-info-circle mr-2"></i>${message}
        </div>
      `);
      
      $('body').append(notification);
      
      setTimeout(() => {
        notification.fadeOut(300, function() {
          $(this).remove();
        });
      }, 3000);
    }

    function handleSuccess(response) {
      if (response.success) {
        currentReceiptData = response.data;
        showReceipt(response.data);
        
        // PERBAIKAN: Jangan reset form dengan cara native
        // Sebagai gantinya, reset field-field tertentu tapi pertahankan penerima
        $('#nis, #jenisTagihan').val(null).trigger('change');
        $('#tagihanList').empty();
        $('#tagihanSection').addClass('hidden');
        $('#tagihanInfo').addClass('hidden');
        $('#nama').val('');
        $('#kategori').val('');
        $('#metode').val('');
        $('#catatan').val('');
        $('#enableBiayaAdmin').prop('checked', false).trigger('change');
        $('#biayaAdminJumlah').val(0);
        $('#biayaAdminKeterangan').val('');
        $('#biayaAdminPreset').val('');
        $('#grandTotalRow').remove();
        calculateTotals();
        
        // PERBAIKAN: Pastikan field penerima tetap terisi
        refreshPenerimaField();
      }
      $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i> Simpan Pembayaran');
    }

    function handleError(error) {
      alert('Error: ' + error.message);
      $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i> Simpan Pembayaran');
    }

    function showReceipt(data) {
      let tagihanHtml = '';
      let totalTagihan = 0;

      // Detail tagihan regular
      data.tagihan.forEach(tagihan => {
        const jumlah = Number(tagihan.jumlahDibayar);
        totalTagihan += jumlah;
        tagihanHtml += `
          <div style="margin-bottom: 6px; font-size: 9pt;">
            <div style="display: flex; justify-content: space-between;">
              <span>${tagihan.jenisTagihan}:</span>
              <span>Rp${jumlah.toLocaleString('id-ID')}</span>
            </div>
          </div>
        `;
      });

      // BARU: Tambahkan biaya admin jika ada
      let biayaAdminHtml = '';
      let grandTotal = totalTagihan;
      
      if (data.biayaAdmin && data.biayaAdmin.jumlah > 0) {
        const biayaAdminAmount = Number(data.biayaAdmin.jumlah);
        grandTotal += biayaAdminAmount;
        
        biayaAdminHtml = `
          <div style="border-top: 1px dashed #ccc; margin-top: 6px; padding-top: 6px;">
            <div style="margin-bottom: 6px; font-size: 9pt;">
              <div style="display: flex; justify-content: space-between;">
                <span style="font-style: italic;">${data.biayaAdmin.keterangan}:</span>
                <span>Rp${biayaAdminAmount.toLocaleString('id-ID')}</span>
              </div>
            </div>
          </div>
        `;
      }

      const logoHtml = kwitansiLogoDataUrl 
        ? `<img src="${kwitansiLogoDataUrl}" alt="Logo" style="max-height: 64px; max-width: 150px; margin: 0 auto 8px; display: block;">`
        : '<div style="height: 64px; margin-bottom: 8px;"></div>'; // Placeholder jika logo tidak tersedia

      const receiptHtml = `
        <div style="font-family: 'Arial', sans-serif; color: #000;">
          <!-- Header dengan Logo Kwitansi -->
          <div style="text-align: center; margin-bottom: 8px;">
            ${logoHtml}
            <div style="font-size: 9pt; margin-bottom: 4px;">
              <strong>${APP_CONFIG.pondokName}</strong><br>
              ${APP_CONFIG.pesantrenName}<br>
              Periode ${APP_CONFIG.academicYear}
            </div>
            <h2 style="font-weight: bold; margin: 4px 0; font-size: 14pt;">KWITANSI PEMBAYARAN</h2>
            <div style="font-size: 8pt;">${data.id}</div>
          </div>
          <!-- Info Santri -->
          <div style="border-bottom: 1px solid #000; padding-bottom: 6px; margin-bottom: 6px;">
            <div style="display: flex; justify-content: space-between; font-size: 9pt;">
              <span>Nama:</span>
              <span>${data.nama}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 9pt;">
              <span>NIS:</span>
              <span>${data.nis}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 9pt;">
              <span>Kategori:</span>
              <span>${data.kategori}</span>
            </div>
          </div>

          <!-- Detail Tagihan -->
          ${tagihanHtml}

          <!-- Biaya Admin (jika ada) -->
          ${biayaAdminHtml}

          <!-- Total -->
          <div style="border-top: 1px solid #000; padding-top: 6px; margin-top: 6px; font-size: 10pt;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
              <span>${data.biayaAdmin && data.biayaAdmin.jumlah > 0 ? 'TOTAL KESELURUHAN:' : 'TOTAL:'}</span>
              <span>Rp${grandTotal.toLocaleString('id-ID')}</span>
            </div>
          </div>

          <!-- Footer -->
          <div style="margin-top: 8px; font-size: 8pt;">
            <div style="display: flex; justify-content: space-between;">
              <span>Metode:</span>
              <span>${data.metode}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Penerima:</span>
              <span>${data.penerima}</span>
            </div>
            <div style="text-align: center; margin-top: 6px;">
              <p style="margin: 2px 0;">${data.tanggal}</p>
              <p style="margin: 2px 0; font-style: italic;">${data.catatan || ''}</p>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-200 text-center text-sm">
              <p style="margin: 2px 0; font-style: italic;">Kwitansi pembayaran ini adalah bukti resmi yang sah. Harap disimpan dengan baik.</p>
              <p style="margin: 2px 0; font-style: italic;">Terima kasih telah melakukan pembayaran.</p>
            </div>
          </div>
        </div>
      `;

      $('#receiptContent').html(receiptHtml);
      $('#receiptModal').removeClass('hidden');
      
      setTimeout(function() {
        autoDownloadReceipt(data);
      }, 1000); // Delay 500ms untuk memastikan konten sudah ter-render
    }
    
	function autoDownloadReceipt(data) {
	  const element = document.getElementById('receiptContent');
	  const filename = `Kwitansi_${data.nama.replace(/\s+/g, '_')}_${data.nis}_${Date.now()}.pdf`;
	  
	  // Tunggu hingga semua gambar dan konten ter-load
	  const images = element.getElementsByTagName('img');
	  const imageLoadPromises = Array.from(images).map(img => {
		if (img.complete) return Promise.resolve();
		return new Promise(resolve => {
		  img.onload = resolve;
		  img.onerror = resolve; // Resolve juga jika error
		});
	  });
	  
	  Promise.all(imageLoadPromises).then(() => {
		// Hitung tinggi konten yang sebenarnya
		const contentHeight = element.scrollHeight;
		const pdfHeight = Math.max(contentHeight * 0.2645, 100); // Minimal 100mm
		
		const options = {
		  margin: [2, 0, 2, 0], // [top, left, bottom, right] dalam mm
		  filename: filename,
		  image: { 
			type: 'jpeg', 
			quality: 0.98 
		  },
		  html2canvas: {
			scale: 3, // Tingkatkan scale dari 2 ke 3 untuk kualitas lebih baik
			logging: false,
			useCORS: true,
			letterRendering: true,
			allowTaint: true,
			scrollY: 0,
			scrollX: 0,
			windowHeight: contentHeight + 100 // Tambah buffer
		  },
		  jsPDF: {
			unit: 'mm',
			format: [80, pdfHeight], // Gunakan tinggi yang dihitung
			orientation: 'portrait',
			compress: true
		  },
		  pagebreak: { 
			mode: ['avoid-all', 'css', 'legacy'],
			before: '.page-break-before',
			after: '.page-break-after'
		  }
		};

		// Generate PDF dengan error handling
		html2pdf()
		  .set(options)
		  .from(element)
		  .save()
		  .catch(err => {
			console.error('Error generating PDF:', err);
			alert('Terjadi kesalahan saat membuat PDF. Silakan coba klik tombol "Simpan PDF" secara manual.');
		  });
	  });
	}
    
    function addNote(note) {
      const catatan = $('#catatan');
      const notes = catatan.val().split(', ').filter(n => n);
      if (notes.includes(note)) {
        catatan.val(notes.filter(n => n !== note).join(', '));
      } else {
        catatan.val([...notes, note].join(', '));
      }
    }
	
    function loadKwitansiLogo() {
      google.script.run
        .withSuccessHandler(function(dataUrl) {
          if (dataUrl) {
            kwitansiLogoDataUrl = dataUrl;
            console.log('Logo kwitansi berhasil dimuat');
          } else {
            console.warn('Logo kwitansi tidak ditemukan');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading kwitansi logo:', error);
        })
        .getKwitansiLogoDataUrl();
    }
  </script>
</body>
</html>
